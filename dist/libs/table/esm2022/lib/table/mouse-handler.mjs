import { TreeRow } from "./data/common/tree-row";
import { getAreaIdentByString } from "./data/tablemodel/area-ident.type";
import { MouseTargetData } from "./data/event/mouse-target-data";
export class MouseHandler {
    tableScope;
    mouseEvent;
    startMouseEvent;
    geMouseEvent;
    geMouseEventOld;
    expandedAll = true;
    mouseDown = false;
    dragging = false;
    constructor(tableScope) {
        this.tableScope = tableScope;
        this.tableScope.hostElement.addEventListener("click", this.onHostElementClicked.bind(this));
        this.tableScope.hostElement.addEventListener("dblclick", this.onHostElementDblClicked.bind(this));
        this.tableScope.hostElement.addEventListener("mousedown", this.onMouseDown.bind(this));
        this.tableScope.hostElement.addEventListener("mousemove", this.onMouseMove.bind(this));
        this.tableScope.hostElement.addEventListener("mouseup", this.onMouseUp.bind(this));
        this.tableScope.hostElement.addEventListener("contextmenu", this.onContextmenu.bind(this));
        // @ts-ignore
        this.tableScope.hostElement['_MouseHandler'] = 'true';
        this.tableScope.scrollViewport.addEventListener("scroll", this.tableScope.adjustAfterScrolling.bind(this.tableScope));
        [window, this.tableScope.hostElement].forEach(ele => ele.addEventListener("resize", this.tableScope.adjustContainersAndRows.bind(this.tableScope)));
    }
    onContextmenu(evt) {
        this.mouseEvent = evt;
        const mouseMoveEvent = this.tableScope.createGeMouseEvent(this.mouseEvent);
        this.tableScope.contextmenu(mouseMoveEvent);
    }
    ;
    onHostElementClicked(event) {
        const mouseTargetData = new MouseTargetData(event.target, this.tableScope);
        if (mouseTargetData.action === 'toggleExpandCollapseAll') {
            this.expandedAll = !this.expandedAll;
            this.tableScope.toggleExpandCollapseAll(this.expandedAll);
            event.preventDefault();
            event.stopPropagation();
        }
        else if (mouseTargetData.inputType === 'checkbox' && mouseTargetData.areaIdent) {
            this.tableScope.toggleRowCheckbox(mouseTargetData.rowIdx, mouseTargetData.colIdx, mouseTargetData.areaIdent);
            //this.tableScope.repaint();
            event.preventDefault();
            event.stopPropagation();
        }
        else if (mouseTargetData.row instanceof TreeRow && mouseTargetData.areaModel) {
            const altClickOnFirstCol = mouseTargetData.colIdx === this.getArrowColumnIndex() && event.altKey;
            const clickOnArrow = mouseTargetData.className.includes("ge-table-tree-arrow-div");
            console.info(clickOnArrow, altClickOnFirstCol);
            if (altClickOnFirstCol || clickOnArrow) {
                // toggle collapsed/expanded:
                event.preventDefault();
                event.stopPropagation();
                const tr = mouseTargetData.row;
                tr.expanded = !tr.expanded;
                if ("recalcVisibleTreeRows" in mouseTargetData.areaModel) {
                    // @ts-ignore
                    mouseTargetData.areaModel.recalcVisibleTreeRows();
                }
                this.tableScope.tableModel.recalcSize(this.tableScope.hostElement.clientWidth);
                this.tableScope.adjustContainersAndRows();
                this.updateCollapsedExpandedState(tr);
            }
        }
        if (mouseTargetData.areaIdent === "body" && this.tableScope.tableOptions.getFocusModel) {
            const fm = this.tableScope.tableOptions.getFocusModel();
            fm?.clear();
            fm?.setFocus(mouseTargetData.rowIdx, mouseTargetData.colIdx);
        }
        this.publishGeMouseEvent(event, 1);
    }
    ;
    onHostElementDblClicked(event) {
        if (event.target instanceof HTMLElement) {
            const target = event.target;
            const area = target.getAttribute("data-area");
            const areaIdent = getAreaIdentByString(area);
            const rowIdx = Number(target.getAttribute("data-row-index"));
            const colIdx = Number(target.getAttribute("data-col-index"));
            const areaModel = this.tableScope.tableModel.getAreaModel(areaIdent);
            if (area && areaIdent === "header") {
                if (this.tableScope.tableModel.isSortable(colIdx)) {
                    this.tableScope.clearSelection();
                    this.tableScope.onHeaderDblClicked(event, rowIdx, colIdx);
                }
            }
            else if (target.getAttribute("data-row-index")) {
                const row = areaModel.getRowByIndex(rowIdx);
                if (area && areaIdent === "body") {
                    if (areaModel.isEditable(rowIdx, colIdx)) {
                        this.tableScope.clearSelection();
                        this.tableScope.initRenderEditor(rowIdx, colIdx);
                    }
                }
                if (row instanceof TreeRow) {
                    if (colIdx === this.getArrowColumnIndex()) {
                        // toggle collapsed/expanded:
                        event.preventDefault();
                        event.stopPropagation();
                        const tr = row;
                        tr.expanded = !tr.expanded;
                        if ("recalcVisibleTreeRows" in areaModel) {
                            // @ts-ignore
                            areaModel.recalcVisibleTreeRows();
                        }
                        this.tableScope.tableModel.recalcSize(this.tableScope.hostElement.clientWidth);
                        this.tableScope.adjustContainersAndRows();
                        this.updateCollapsedExpandedState(tr);
                    }
                }
            }
        }
        this.publishGeMouseEvent(event, 2);
    }
    ;
    publishGeMouseEvent(event, clickCount) {
        this.mouseEvent = event;
        this.geMouseEventOld = this.geMouseEvent?.clone();
        this.geMouseEvent = this.tableScope.createGeMouseEvent(event);
        if (this.geMouseEvent) {
            this.geMouseEvent.clickCount = clickCount;
        }
        this.tableScope.onMouseClicked(this.geMouseEvent, this.geMouseEventOld);
    }
    updateCollapsedExpandedState(tr) {
        // store expanded/collapsed:
        const getRowId = this.tableScope.tableOptions?.autoRestoreOptions?.getRowId;
        if (getRowId) {
            const mode = this.tableScope.storeStateCollapsedExpandService?.collapsedExpandedStateGet().mode;
            const push = (mode === "collapsed" && !tr.expanded) || (mode === "expanded" && tr.expanded);
            const remove = (mode === "collapsed" && tr.expanded) || (mode === "expanded" && !tr.expanded);
            const rowId = getRowId(tr.data);
            if (push) {
                this.tableScope.storeStateCollapsedExpandService?.collapsedStateIdsPush(rowId);
            }
            else if (remove) {
                this.tableScope.storeStateCollapsedExpandService?.collapsedStateIdsRemove(rowId);
            }
        }
    }
    getArrowColumnIndex() {
        const rowCheckboxVisible = this.tableScope.tableModel.isRowCheckboxVisible();
        return rowCheckboxVisible ? 1 : 0;
    }
    onMouseDown(evt) {
        this.mouseEvent = evt;
        this.startMouseEvent = this.tableScope.createGeMouseEvent(this.mouseEvent);
        this.tableScope.onMouseDown(this.startMouseEvent);
        this.mouseDown = true;
    }
    onMouseMove(evt) {
        this.mouseEvent = evt;
        if (this.mouseDown) {
            this.dragging = true;
            requestAnimationFrame(this.mouseDraggingOnFrame.bind(this));
        }
        else {
            requestAnimationFrame(this.mouseMoveOnFrame.bind(this));
        }
    }
    onMouseUp(evt) {
        this.mouseEvent = evt;
        if (this.dragging) {
            requestAnimationFrame(this.mouseDraggingEndOnFrame.bind(this));
        }
        this.mouseDown = false;
        this.dragging = false;
    }
    mouseDraggingOnFrame() {
        if (this.mouseEvent) {
            const mouseEvent = this.tableScope.createGeMouseEvent(this.mouseEvent);
            if (this.startMouseEvent?.originalEvent) {
                mouseEvent.draggingX = this.mouseEvent.clientX - this.startMouseEvent.originalEvent.clientX;
                mouseEvent.draggingY = this.mouseEvent.clientY - this.startMouseEvent.originalEvent.clientY;
            }
            this.tableScope.mouseDraggingOnFrame(mouseEvent);
        }
    }
    mouseDraggingEndOnFrame() {
        if (this.mouseEvent) {
            const mouseEvent = this.tableScope.createGeMouseEvent(this.mouseEvent);
            if (this.startMouseEvent?.originalEvent) {
                mouseEvent.draggingX = this.mouseEvent.clientX - this.startMouseEvent.originalEvent.clientX;
                mouseEvent.draggingY = this.mouseEvent.clientY - this.startMouseEvent.originalEvent.clientY;
            }
            this.tableScope.mouseDraggingEndOnFrame(mouseEvent);
        }
    }
    mouseMoveOnFrame() {
        if (this.mouseEvent) {
            const mouseMoveEvent = this.tableScope.createGeMouseEvent(this.mouseEvent);
            this.tableScope.mouseMove(mouseMoveEvent);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW91c2UtaGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvdGFibGUvc3JjL2xpYi90YWJsZS9tb3VzZS1oYW5kbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNqRCxPQUFPLEVBQWEsb0JBQW9CLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUVwRixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFFakUsTUFBTSxPQUFPLFlBQVk7SUFZWDtJQVZaLFVBQVUsQ0FBYztJQUN4QixlQUFlLENBQWdCO0lBQy9CLFlBQVksQ0FBZ0I7SUFDNUIsZUFBZSxDQUFnQjtJQUV2QixXQUFXLEdBQUcsSUFBSSxDQUFDO0lBQ25CLFNBQVMsR0FBRyxLQUFLLENBQUM7SUFDbEIsUUFBUSxHQUFHLEtBQUssQ0FBQztJQUV6QixZQUNZLFVBQXNCO1FBQXRCLGVBQVUsR0FBVixVQUFVLENBQVk7UUFFaEMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUM1RixJQUFJLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLHVCQUF1QixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ2xHLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ3ZGLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFD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O0lBQ0gsQ0FBQztDQUdGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGFibGVTY29wZSB9IGZyb20gXCIuL3RhYmxlLXNjb3BlXCI7XG5pbXBvcnQgeyBUcmVlUm93IH0gZnJvbSBcIi4vZGF0YS9jb21tb24vdHJlZS1yb3dcIjtcbmltcG9ydCB7IEFyZWFJZGVudCwgZ2V0QXJlYUlkZW50QnlTdHJpbmcgfSBmcm9tIFwiLi9kYXRhL3RhYmxlbW9kZWwvYXJlYS1pZGVudC50eXBlXCI7XG5pbXBvcnQgeyBHZU1vdXNlRXZlbnQgfSBmcm9tIFwiLi9kYXRhL2NvbW1vbi9ldmVudC9nZS1tb3VzZS1ldmVudFwiO1xuaW1wb3J0IHsgTW91c2VUYXJnZXREYXRhIH0gZnJvbSBcIi4vZGF0YS9ldmVudC9tb3VzZS10YXJnZXQtZGF0YVwiO1xuXG5leHBvcnQgY2xhc3MgTW91c2VIYW5kbGVyIHtcblxuICBtb3VzZUV2ZW50PzogTW91c2VFdmVudDtcbiAgc3RhcnRNb3VzZUV2ZW50PzogR2VNb3VzZUV2ZW50O1xuICBnZU1vdXNlRXZlbnQ/OiBHZU1vdXNlRXZlbnQ7XG4gIGdlTW91c2VFdmVudE9sZD86IEdlTW91c2VFdmVudDtcblxuICBwcml2YXRlIGV4cGFuZGVkQWxsID0gdHJ1ZTtcbiAgcHJpdmF0ZSBtb3VzZURvd24gPSBmYWxzZTtcbiAgcHJpdmF0ZSBkcmFnZ2luZyA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByb3RlY3RlZCB0YWJsZVNjb3BlOiBUYWJsZVNjb3BlXG4gICkge1xuICAgIHRoaXMudGFibGVTY29wZS5ob3N0RWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgdGhpcy5vbkhvc3RFbGVtZW50Q2xpY2tlZC5iaW5kKHRoaXMpKTtcbiAgICB0aGlzLnRhYmxlU2NvcGUuaG9zdEVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcImRibGNsaWNrXCIsIHRoaXMub25Ib3N0RWxlbWVudERibENsaWNrZWQuYmluZCh0aGlzKSk7XG4gICAgdGhpcy50YWJsZVNjb3BlLmhvc3RFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJtb3VzZWRvd25cIiwgdGhpcy5vbk1vdXNlRG93bi5iaW5kKHRoaXMpKTtcbiAgICB0aGlzLnRhYmxlU2NvcGUuaG9zdEVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcIm1vdXNlbW92ZVwiLCB0aGlzLm9uTW91c2VNb3ZlLmJpbmQodGhpcykpO1xuICAgIHRoaXMudGFibGVTY29wZS5ob3N0RWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFwibW91c2V1cFwiLCB0aGlzLm9uTW91c2VVcC5iaW5kKHRoaXMpKTtcbiAgICB0aGlzLnRhYmxlU2NvcGUuaG9zdEVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcImNvbnRleHRtZW51XCIsIHRoaXMub25Db250ZXh0bWVudS5iaW5kKHRoaXMpKTtcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgdGhpcy50YWJsZVNjb3BlLmhvc3RFbGVtZW50WydfTW91c2VIYW5kbGVyJ10gPSAndHJ1ZSc7XG5cbiAgICB0aGlzLnRhYmxlU2NvcGUuc2Nyb2xsVmlld3BvcnQuYWRkRXZlbnRMaXN0ZW5lcihcInNjcm9sbFwiLCB0aGlzLnRhYmxlU2NvcGUuYWRqdXN0QWZ0ZXJTY3JvbGxpbmcuYmluZCh0aGlzLnRhYmxlU2NvcGUpKTtcblxuICAgIFt3aW5kb3csIHRoaXMudGFibGVTY29wZS5ob3N0RWxlbWVudF0uZm9yRWFjaChcbiAgICAgIGVsZSA9PiBlbGUuYWRkRXZlbnRMaXN0ZW5lcihcInJlc2l6ZVwiLCB0aGlzLnRhYmxlU2NvcGUuYWRqdXN0Q29udGFpbmVyc0FuZFJvd3MuYmluZCh0aGlzLnRhYmxlU2NvcGUpKVxuICAgICk7XG4gIH1cblxuXG4gIHByaXZhdGUgb25Db250ZXh0bWVudShldnQ6IE1vdXNlRXZlbnQpIHtcbiAgICB0aGlzLm1vdXNlRXZlbnQgPSBldnQ7XG4gICAgY29uc3QgbW91c2VNb3ZlRXZlbnQgPSB0aGlzLnRhYmxlU2NvcGUuY3JlYXRlR2VNb3VzZUV2ZW50KHRoaXMubW91c2VFdmVudCk7XG4gICAgdGhpcy50YWJsZVNjb3BlLmNvbnRleHRtZW51KG1vdXNlTW92ZUV2ZW50KTtcbiAgfTtcblxuXG4gIHByaXZhdGUgb25Ib3N0RWxlbWVudENsaWNrZWQoZXZlbnQ6IE1vdXNlRXZlbnQpIHtcbiAgICBjb25zdCBtb3VzZVRhcmdldERhdGE6IE1vdXNlVGFyZ2V0RGF0YSA9IG5ldyBNb3VzZVRhcmdldERhdGEoZXZlbnQudGFyZ2V0LCB0aGlzLnRhYmxlU2NvcGUpO1xuICAgIGlmIChtb3VzZVRhcmdldERhdGEuYWN0aW9uID09PSAndG9nZ2xlRXhwYW5kQ29sbGFwc2VBbGwnKXtcbiAgICAgIHRoaXMuZXhwYW5kZWRBbGwgPSAhdGhpcy5leHBhbmRlZEFsbDtcbiAgICAgIHRoaXMudGFibGVTY29wZS50b2dnbGVFeHBhbmRDb2xsYXBzZUFsbCh0aGlzLmV4cGFuZGVkQWxsKTtcbiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcblxuICAgIH0gZWxzZSBpZiAobW91c2VUYXJnZXREYXRhLmlucHV0VHlwZSA9PT0gJ2NoZWNrYm94JyAmJiBtb3VzZVRhcmdldERhdGEuYXJlYUlkZW50KXtcbiAgICAgIHRoaXMudGFibGVTY29wZS50b2dnbGVSb3dDaGVja2JveChtb3VzZVRhcmdldERhdGEucm93SWR4LCBtb3VzZVRhcmdldERhdGEuY29sSWR4LCBtb3VzZVRhcmdldERhdGEuYXJlYUlkZW50KTtcbiAgICAgIC8vdGhpcy50YWJsZVNjb3BlLnJlcGFpbnQoKTtcbiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcblxuICAgIH0gZWxzZSBpZiAobW91c2VUYXJnZXREYXRhLnJvdyBpbnN0YW5jZW9mIFRyZWVSb3cgJiYgbW91c2VUYXJnZXREYXRhLmFyZWFNb2RlbCkge1xuICAgICAgY29uc3QgYWx0Q2xpY2tPbkZpcnN0Q29sID0gbW91c2VUYXJnZXREYXRhLmNvbElkeCA9PT0gdGhpcy5nZXRBcnJvd0NvbHVtbkluZGV4KCkgJiYgZXZlbnQuYWx0S2V5O1xuICAgICAgY29uc3QgY2xpY2tPbkFycm93ID0gbW91c2VUYXJnZXREYXRhLmNsYXNzTmFtZS5pbmNsdWRlcyhcImdlLXRhYmxlLXRyZWUtYXJyb3ctZGl2XCIpO1xuICAgICAgY29uc29sZS5pbmZvKGNsaWNrT25BcnJvdywgYWx0Q2xpY2tPbkZpcnN0Q29sKTtcblxuICAgICAgaWYgKGFsdENsaWNrT25GaXJzdENvbCB8fCBjbGlja09uQXJyb3cpIHtcbiAgICAgICAgLy8gdG9nZ2xlIGNvbGxhcHNlZC9leHBhbmRlZDpcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIGNvbnN0IHRyOiBUcmVlUm93PGFueT4gPSBtb3VzZVRhcmdldERhdGEucm93IGFzIFRyZWVSb3c8YW55PjtcbiAgICAgICAgdHIuZXhwYW5kZWQgPSAhdHIuZXhwYW5kZWQ7XG5cbiAgICAgICAgaWYgKFwicmVjYWxjVmlzaWJsZVRyZWVSb3dzXCIgaW4gbW91c2VUYXJnZXREYXRhLmFyZWFNb2RlbCkge1xuICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICBtb3VzZVRhcmdldERhdGEuYXJlYU1vZGVsLnJlY2FsY1Zpc2libGVUcmVlUm93cygpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMudGFibGVTY29wZS50YWJsZU1vZGVsLnJlY2FsY1NpemUodGhpcy50YWJsZVNjb3BlLmhvc3RFbGVtZW50LmNsaWVudFdpZHRoKTtcbiAgICAgICAgdGhpcy50YWJsZVNjb3BlLmFkanVzdENvbnRhaW5lcnNBbmRSb3dzKCk7XG4gICAgICAgIHRoaXMudXBkYXRlQ29sbGFwc2VkRXhwYW5kZWRTdGF0ZSh0cik7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKG1vdXNlVGFyZ2V0RGF0YS5hcmVhSWRlbnQgPT09IFwiYm9keVwiICYmIHRoaXMudGFibGVTY29wZS50YWJsZU9wdGlvbnMuZ2V0Rm9jdXNNb2RlbCkge1xuICAgICAgY29uc3QgZm0gPSB0aGlzLnRhYmxlU2NvcGUudGFibGVPcHRpb25zLmdldEZvY3VzTW9kZWwoKTtcbiAgICAgIGZtPy5jbGVhcigpO1xuICAgICAgZm0/LnNldEZvY3VzKG1vdXNlVGFyZ2V0RGF0YS5yb3dJZHgsIG1vdXNlVGFyZ2V0RGF0YS5jb2xJZHgpO1xuICAgIH1cblxuICAgIHRoaXMucHVibGlzaEdlTW91c2VFdmVudChldmVudCwgMSk7XG4gIH07XG5cblxuICBwcml2YXRlIG9uSG9zdEVsZW1lbnREYmxDbGlja2VkKGV2ZW50OiBNb3VzZUV2ZW50KSB7XG5cbiAgICBpZiAoZXZlbnQudGFyZ2V0IGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpIHtcbiAgICAgIGNvbnN0IHRhcmdldCA9IGV2ZW50LnRhcmdldCBhcyBIVE1MRWxlbWVudDtcbiAgICAgIGNvbnN0IGFyZWEgPSB0YXJnZXQuZ2V0QXR0cmlidXRlKFwiZGF0YS1hcmVhXCIpO1xuICAgICAgY29uc3QgYXJlYUlkZW50OiBBcmVhSWRlbnQgPSBnZXRBcmVhSWRlbnRCeVN0cmluZyhhcmVhKTtcbiAgICAgIGNvbnN0IHJvd0lkeCA9IE51bWJlcih0YXJnZXQuZ2V0QXR0cmlidXRlKFwiZGF0YS1yb3ctaW5kZXhcIikpO1xuICAgICAgY29uc3QgY29sSWR4ID0gTnVtYmVyKHRhcmdldC5nZXRBdHRyaWJ1dGUoXCJkYXRhLWNvbC1pbmRleFwiKSk7XG4gICAgICBjb25zdCBhcmVhTW9kZWwgPSB0aGlzLnRhYmxlU2NvcGUudGFibGVNb2RlbC5nZXRBcmVhTW9kZWwoYXJlYUlkZW50KTtcblxuICAgICAgaWYgKGFyZWEgJiYgYXJlYUlkZW50ID09PSBcImhlYWRlclwiKSB7XG4gICAgICAgIGlmICh0aGlzLnRhYmxlU2NvcGUudGFibGVNb2RlbC5pc1NvcnRhYmxlKGNvbElkeCkpIHtcbiAgICAgICAgICB0aGlzLnRhYmxlU2NvcGUuY2xlYXJTZWxlY3Rpb24oKTtcbiAgICAgICAgICB0aGlzLnRhYmxlU2NvcGUub25IZWFkZXJEYmxDbGlja2VkKGV2ZW50LCByb3dJZHgsIGNvbElkeCk7XG4gICAgICAgIH1cblxuICAgICAgfSBlbHNlIGlmICh0YXJnZXQuZ2V0QXR0cmlidXRlKFwiZGF0YS1yb3ctaW5kZXhcIikpIHtcbiAgICAgICAgY29uc3Qgcm93ID0gYXJlYU1vZGVsLmdldFJvd0J5SW5kZXgocm93SWR4KTtcblxuICAgICAgICBpZiAoYXJlYSAmJiBhcmVhSWRlbnQgPT09IFwiYm9keVwiKSB7XG4gICAgICAgICAgaWYgKGFyZWFNb2RlbC5pc0VkaXRhYmxlKHJvd0lkeCwgY29sSWR4KSkge1xuICAgICAgICAgICAgdGhpcy50YWJsZVNjb3BlLmNsZWFyU2VsZWN0aW9uKCk7XG4gICAgICAgICAgICB0aGlzLnRhYmxlU2NvcGUuaW5pdFJlbmRlckVkaXRvcihyb3dJZHgsIGNvbElkeCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHJvdyBpbnN0YW5jZW9mIFRyZWVSb3cpIHtcbiAgICAgICAgICBpZiAoY29sSWR4ID09PSB0aGlzLmdldEFycm93Q29sdW1uSW5kZXgoKSkge1xuICAgICAgICAgICAgLy8gdG9nZ2xlIGNvbGxhcHNlZC9leHBhbmRlZDpcbiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgIGNvbnN0IHRyOiBUcmVlUm93PGFueT4gPSByb3cgYXMgVHJlZVJvdzxhbnk+O1xuICAgICAgICAgICAgdHIuZXhwYW5kZWQgPSAhdHIuZXhwYW5kZWQ7XG5cbiAgICAgICAgICAgIGlmIChcInJlY2FsY1Zpc2libGVUcmVlUm93c1wiIGluIGFyZWFNb2RlbCkge1xuICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICAgIGFyZWFNb2RlbC5yZWNhbGNWaXNpYmxlVHJlZVJvd3MoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMudGFibGVTY29wZS50YWJsZU1vZGVsLnJlY2FsY1NpemUodGhpcy50YWJsZVNjb3BlLmhvc3RFbGVtZW50LmNsaWVudFdpZHRoKTtcbiAgICAgICAgICAgIHRoaXMudGFibGVTY29wZS5hZGp1c3RDb250YWluZXJzQW5kUm93cygpO1xuXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZUNvbGxhcHNlZEV4cGFuZGVkU3RhdGUodHIpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMucHVibGlzaEdlTW91c2VFdmVudChldmVudCwgMik7XG4gIH07XG5cblxuICBwcml2YXRlIHB1Ymxpc2hHZU1vdXNlRXZlbnQoZXZlbnQ6IE1vdXNlRXZlbnQsIGNsaWNrQ291bnQ6IG51bWJlcikge1xuICAgIHRoaXMubW91c2VFdmVudCA9IGV2ZW50O1xuICAgIHRoaXMuZ2VNb3VzZUV2ZW50T2xkID0gdGhpcy5nZU1vdXNlRXZlbnQ/LmNsb25lKCk7XG4gICAgdGhpcy5nZU1vdXNlRXZlbnQgPSB0aGlzLnRhYmxlU2NvcGUuY3JlYXRlR2VNb3VzZUV2ZW50KGV2ZW50KTtcbiAgICBpZiAodGhpcy5nZU1vdXNlRXZlbnQpIHtcbiAgICAgIHRoaXMuZ2VNb3VzZUV2ZW50LmNsaWNrQ291bnQgPSBjbGlja0NvdW50O1xuICAgIH1cbiAgICB0aGlzLnRhYmxlU2NvcGUub25Nb3VzZUNsaWNrZWQodGhpcy5nZU1vdXNlRXZlbnQsIHRoaXMuZ2VNb3VzZUV2ZW50T2xkKTtcbiAgfVxuXG5cbiAgcHJpdmF0ZSB1cGRhdGVDb2xsYXBzZWRFeHBhbmRlZFN0YXRlKHRyOiBUcmVlUm93PGFueT4pIHtcbiAgICAvLyBzdG9yZSBleHBhbmRlZC9jb2xsYXBzZWQ6XG4gICAgY29uc3QgZ2V0Um93SWQgPSB0aGlzLnRhYmxlU2NvcGUudGFibGVPcHRpb25zPy5hdXRvUmVzdG9yZU9wdGlvbnM/LmdldFJvd0lkO1xuICAgIGlmIChnZXRSb3dJZCkge1xuICAgICAgY29uc3QgbW9kZSA9IHRoaXMudGFibGVTY29wZS5zdG9yZVN0YXRlQ29sbGFwc2VkRXhwYW5kU2VydmljZT8uY29sbGFwc2VkRXhwYW5kZWRTdGF0ZUdldCgpLm1vZGU7XG4gICAgICBjb25zdCBwdXNoID0gKG1vZGUgPT09IFwiY29sbGFwc2VkXCIgJiYgIXRyLmV4cGFuZGVkKSB8fCAobW9kZSA9PT0gXCJleHBhbmRlZFwiICYmIHRyLmV4cGFuZGVkKTtcbiAgICAgIGNvbnN0IHJlbW92ZSA9IChtb2RlID09PSBcImNvbGxhcHNlZFwiICYmIHRyLmV4cGFuZGVkKSB8fCAobW9kZSA9PT0gXCJleHBhbmRlZFwiICYmICF0ci5leHBhbmRlZCk7XG4gICAgICBjb25zdCByb3dJZCA9IGdldFJvd0lkKHRyLmRhdGEpO1xuICAgICAgaWYgKHB1c2gpIHtcbiAgICAgICAgdGhpcy50YWJsZVNjb3BlLnN0b3JlU3RhdGVDb2xsYXBzZWRFeHBhbmRTZXJ2aWNlPy5jb2xsYXBzZWRTdGF0ZUlkc1B1c2gocm93SWQpO1xuICAgICAgfSBlbHNlIGlmIChyZW1vdmUpIHtcbiAgICAgICAgdGhpcy50YWJsZVNjb3BlLnN0b3JlU3RhdGVDb2xsYXBzZWRFeHBhbmRTZXJ2aWNlPy5jb2xsYXBzZWRTdGF0ZUlkc1JlbW92ZShyb3dJZCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cblxuICBwcml2YXRlIGdldEFycm93Q29sdW1uSW5kZXgoKTogbnVtYmVyIHtcbiAgICBjb25zdCByb3dDaGVja2JveFZpc2libGUgPSB0aGlzLnRhYmxlU2NvcGUudGFibGVNb2RlbC5pc1Jvd0NoZWNrYm94VmlzaWJsZSgpO1xuICAgIHJldHVybiByb3dDaGVja2JveFZpc2libGUgPyAxIDogMDtcbiAgfVxuXG5cbiAgcHJpdmF0ZSBvbk1vdXNlRG93bihldnQ6IE1vdXNlRXZlbnQpIHtcbiAgICB0aGlzLm1vdXNlRXZlbnQgPSBldnQ7XG4gICAgdGhpcy5zdGFydE1vdXNlRXZlbnQgPSB0aGlzLnRhYmxlU2NvcGUuY3JlYXRlR2VNb3VzZUV2ZW50KHRoaXMubW91c2VFdmVudCk7XG4gICAgdGhpcy50YWJsZVNjb3BlLm9uTW91c2VEb3duKHRoaXMuc3RhcnRNb3VzZUV2ZW50KTtcbiAgICB0aGlzLm1vdXNlRG93biA9IHRydWU7XG4gIH1cblxuXG4gIHByaXZhdGUgb25Nb3VzZU1vdmUoZXZ0OiBNb3VzZUV2ZW50KSB7XG4gICAgdGhpcy5tb3VzZUV2ZW50ID0gZXZ0O1xuICAgIGlmICh0aGlzLm1vdXNlRG93bikge1xuICAgICAgdGhpcy5kcmFnZ2luZyA9IHRydWU7XG4gICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGhpcy5tb3VzZURyYWdnaW5nT25GcmFtZS5iaW5kKHRoaXMpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRoaXMubW91c2VNb3ZlT25GcmFtZS5iaW5kKHRoaXMpKTtcbiAgICB9XG4gIH1cblxuXG4gIHByaXZhdGUgb25Nb3VzZVVwKGV2dDogTW91c2VFdmVudCkge1xuICAgIHRoaXMubW91c2VFdmVudCA9IGV2dDtcbiAgICBpZiAodGhpcy5kcmFnZ2luZykge1xuICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRoaXMubW91c2VEcmFnZ2luZ0VuZE9uRnJhbWUuYmluZCh0aGlzKSk7XG4gICAgfVxuICAgIHRoaXMubW91c2VEb3duID0gZmFsc2U7XG4gICAgdGhpcy5kcmFnZ2luZyA9IGZhbHNlO1xuICB9XG5cblxuICBwcml2YXRlIG1vdXNlRHJhZ2dpbmdPbkZyYW1lKCkge1xuICAgIGlmICh0aGlzLm1vdXNlRXZlbnQpIHtcbiAgICAgIGNvbnN0IG1vdXNlRXZlbnQgPSB0aGlzLnRhYmxlU2NvcGUuY3JlYXRlR2VNb3VzZUV2ZW50KHRoaXMubW91c2VFdmVudCk7XG4gICAgICBpZiAodGhpcy5zdGFydE1vdXNlRXZlbnQ/Lm9yaWdpbmFsRXZlbnQpIHtcbiAgICAgICAgbW91c2VFdmVudC5kcmFnZ2luZ1ggPSB0aGlzLm1vdXNlRXZlbnQuY2xpZW50WCAtIHRoaXMuc3RhcnRNb3VzZUV2ZW50Lm9yaWdpbmFsRXZlbnQuY2xpZW50WDtcbiAgICAgICAgbW91c2VFdmVudC5kcmFnZ2luZ1kgPSB0aGlzLm1vdXNlRXZlbnQuY2xpZW50WSAtIHRoaXMuc3RhcnRNb3VzZUV2ZW50Lm9yaWdpbmFsRXZlbnQuY2xpZW50WTtcbiAgICAgIH1cbiAgICAgIHRoaXMudGFibGVTY29wZS5tb3VzZURyYWdnaW5nT25GcmFtZShtb3VzZUV2ZW50KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG1vdXNlRHJhZ2dpbmdFbmRPbkZyYW1lKCkge1xuICAgIGlmICh0aGlzLm1vdXNlRXZlbnQpIHtcbiAgICAgIGNvbnN0IG1vdXNlRXZlbnQgPSB0aGlzLnRhYmxlU2NvcGUuY3JlYXRlR2VNb3VzZUV2ZW50KHRoaXMubW91c2VFdmVudCk7XG4gICAgICBpZiAodGhpcy5zdGFydE1vdXNlRXZlbnQ/Lm9yaWdpbmFsRXZlbnQpIHtcbiAgICAgICAgbW91c2VFdmVudC5kcmFnZ2luZ1ggPSB0aGlzLm1vdXNlRXZlbnQuY2xpZW50WCAtIHRoaXMuc3RhcnRNb3VzZUV2ZW50Lm9yaWdpbmFsRXZlbnQuY2xpZW50WDtcbiAgICAgICAgbW91c2VFdmVudC5kcmFnZ2luZ1kgPSB0aGlzLm1vdXNlRXZlbnQuY2xpZW50WSAtIHRoaXMuc3RhcnRNb3VzZUV2ZW50Lm9yaWdpbmFsRXZlbnQuY2xpZW50WTtcbiAgICAgIH1cbiAgICAgIHRoaXMudGFibGVTY29wZS5tb3VzZURyYWdnaW5nRW5kT25GcmFtZShtb3VzZUV2ZW50KTtcbiAgICB9XG4gIH1cblxuXG4gIHByaXZhdGUgbW91c2VNb3ZlT25GcmFtZSgpIHtcbiAgICBpZiAodGhpcy5tb3VzZUV2ZW50KSB7XG4gICAgICBjb25zdCBtb3VzZU1vdmVFdmVudCA9IHRoaXMudGFibGVTY29wZS5jcmVhdGVHZU1vdXNlRXZlbnQodGhpcy5tb3VzZUV2ZW50KTtcbiAgICAgIHRoaXMudGFibGVTY29wZS5tb3VzZU1vdmUobW91c2VNb3ZlRXZlbnQpO1xuICAgIH1cbiAgfVxuXG5cbn1cbiJdfQ==