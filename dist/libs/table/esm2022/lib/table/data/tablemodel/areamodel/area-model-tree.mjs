import { TreeRowService } from "../../../service/tree-row.service";
import { AbstractAreaModel } from "./abstract-area-model";
import { SorterService } from "../../../service/sorter.service";
export class AreaModelTree extends AbstractAreaModel {
    areaIdent;
    rows;
    defaultRowHeight;
    columnDefs;
    properties;
    sorterService = new SorterService();
    service = new TreeRowService();
    filteredFlattenRows;
    flattenRows;
    lastPredictFn;
    constructor(areaIdent, rows, defaultRowHeight, columnDefs = []) {
        super(areaIdent, columnDefs, defaultRowHeight);
        this.areaIdent = areaIdent;
        this.rows = rows;
        this.defaultRowHeight = defaultRowHeight;
        this.columnDefs = columnDefs;
        this.properties = columnDefs.map(def => def.property);
        this.flattenRows = this.service.flattenTree(rows);
        this.filteredFlattenRows = [...this.flattenRows];
    }
    changeColumnOrder(sourceColumnIndex, targetColumnIndex) {
        //  not this! this.arrayMove(this.columnDefs...)
        this.arrayMove(this.properties, sourceColumnIndex, targetColumnIndex);
        super.changeColumnOrder(sourceColumnIndex, targetColumnIndex);
    }
    recalcVisibleTreeRows() {
        this.filteredFlattenRows = this.service.flattenTree(this.rows);
    }
    getFilteredFlattenRows() {
        return this.filteredFlattenRows;
    }
    getRowCount() {
        let n = 0;
        for (const r of this.filteredFlattenRows) {
            if (this.service.isVisible(r)) {
                n++;
            }
        }
        return n;
    }
    getValueAt(rowIndex, columnIndex) {
        const row = this.getRowByIndex(rowIndex);
        if (row) {
            const prop = this.properties[columnIndex];
            if (prop) {
                if (prop.includes(".")) {
                    return this.getPropertyValue(row.data, prop.split("."));
                }
                // @ts-ignore
                return row.data[prop];
            }
        }
        return "";
    }
    getRowHeight(_rowIndex) {
        return this.defaultRowHeight;
    }
    getCustomClassesAt(rowIndex, _columnIndex) {
        const row = this.filteredFlattenRows[rowIndex];
        return ["ge-table-tree-cell", "ge-table-tree-deep-" + row.deep];
    }
    getRowByIndex(idx) {
        return this.filteredFlattenRows[idx];
    }
    getValueByT(t, property) {
        if (property.includes(".")) {
            return this.getPropertyValue(t, property.split("."));
        }
        // @ts-ignore
        return t[property];
    }
    externalFilterChanged(predictFn) {
        this.lastPredictFn = predictFn;
        this.doFiltering();
    }
    doSort(sortItems) {
        const { columnIndex, sortState } = sortItems[sortItems.length - 1];
        const f = sortState === "asc" ? 1 :
            sortState === "desc" ? -1 : 0;
        const property = this.properties[columnIndex];
        this.treeSort(this.rows, property, f);
        this.flattenRows = this.service.flattenTree(this.rows);
        this.filteredFlattenRows = [...this.flattenRows];
        return true;
    }
    toggleExpandCollapseAll(expanded) {
        this.expandAllRecursive(this.rows, expanded);
        this.flattenRows = this.service.flattenTree(this.rows);
        this.doFiltering();
    }
    setAllParentsOk(item) {
        if (item.parent) {
            item.parent.keep = true;
            this.setAllParentsOk(item.parent);
        }
        return false;
    }
    setValue(rowIndex, columnIndex, value) {
        const editInputPipe = this.columnDefs[columnIndex]?.editInputPipe;
        if (editInputPipe) {
            value = editInputPipe(value, rowIndex, columnIndex);
        }
        const treeRow = this.getRowByIndex(rowIndex);
        if (treeRow) {
            const row = treeRow.data;
            const property = this.columnDefs[columnIndex].property;
            if (property.includes(".")) {
                return this.setPropertyValue(row, property.split("."), value);
            }
            // @ts-ignore
            row[property] = value;
            return true;
        }
        return false;
    }
    genericTreeTableSortComparator(property, f) {
        return (a, b) => {
            const va = this.getValueByT(a.data, property);
            const vb = this.getValueByT(b.data, property);
            return this.sorterService.genericSortComparator(va, vb, f);
        };
    }
    expandAllRecursive(arr, expanded) {
        for (const row of arr) {
            row.expanded = expanded;
            if (row.children) {
                this.expandAllRecursive(row.children, expanded);
            }
        }
    }
    doFiltering() {
        if (!this.lastPredictFn) {
            this.filteredFlattenRows = [...(this.flattenRows ? this.flattenRows : [])];
        }
        else {
            if (!this.flattenRows) {
                this.flattenRows = [];
            }
            let maxDeep = 0;
            this.flattenRows.forEach(v => {
                maxDeep = Math.max(maxDeep, v.deep);
            });
            const okRows = this.flattenRows.filter((value, index, array) => {
                // @ts-ignore
                return this.lastPredictFn(value, index, array);
            });
            this.flattenRows.forEach(v => v.keep = false);
            this.flattenRows.forEach(v => {
                if (okRows.includes(v)) {
                    v.keep = true;
                    this.setAllParentsOk(v);
                }
            });
            this.filteredFlattenRows = this.flattenRows.filter((value, _index, _array) => {
                return value.keep;
            });
        }
    }
    getPropertyValue(o, props) {
        const prop = props.shift();
        // @ts-ignore
        let o2 = o[prop];
        if (o2 && props.length) {
            return this.getPropertyValue(o2, props);
        }
        return o2;
    }
    treeSort(rows, property, f) {
        rows.sort(this.genericTreeTableSortComparator(property, f));
        for (const row of rows) {
            if (row.children) {
                this.treeSort(row.children, property, f);
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXJlYS1tb2RlbC10cmVlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vbGlicy90YWJsZS9zcmMvbGliL3RhYmxlL2RhdGEvdGFibGVtb2RlbC9hcmVhbW9kZWwvYXJlYS1tb2RlbC10cmVlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUNuRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUkxRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFHaEUsTUFBTSxPQUFPLGFBQWlCLFNBQVEsaUJBQTZCO0lBVy9DO0lBQ0E7SUFDQztJQUNFO0lBWkYsVUFBVSxDQUFXO0lBQzlCLGFBQWEsR0FBa0IsSUFBSSxhQUFhLEVBQUUsQ0FBQztJQUU1QyxPQUFPLEdBQUcsSUFBSSxjQUFjLEVBQUUsQ0FBQztJQUN4QyxtQkFBbUIsQ0FBZTtJQUNsQyxXQUFXLENBQWU7SUFDMUIsYUFBYSxDQUF1QjtJQUU1QyxZQUNrQixTQUFvQixFQUNwQixJQUFrQixFQUNqQixnQkFBd0IsRUFDdEIsYUFBNEIsRUFBRTtRQUVqRCxLQUFLLENBQUMsU0FBUyxFQUFFLFVBQVUsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1FBTC9CLGNBQVMsR0FBVCxTQUFTLENBQVc7UUFDcEIsU0FBSSxHQUFKLElBQUksQ0FBYztRQUNqQixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQVE7UUFDdEIsZUFBVSxHQUFWLFVBQVUsQ0FBb0I7UUFHakQsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3RELElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7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QUFFLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQzthQUMxQztTQUNGO0lBQ0gsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVHJlZVJvdyB9IGZyb20gXCIuLi8uLi9jb21tb24vdHJlZS1yb3dcIjtcbmltcG9ydCB7IFRyZWVSb3dTZXJ2aWNlIH0gZnJvbSBcIi4uLy4uLy4uL3NlcnZpY2UvdHJlZS1yb3cuc2VydmljZVwiO1xuaW1wb3J0IHsgQWJzdHJhY3RBcmVhTW9kZWwgfSBmcm9tIFwiLi9hYnN0cmFjdC1hcmVhLW1vZGVsXCI7XG5pbXBvcnQgeyBBcmVhSWRlbnQgfSBmcm9tIFwiLi4vYXJlYS1pZGVudC50eXBlXCI7XG5pbXBvcnQgeyBDb2x1bW5EZWZJZiB9IGZyb20gXCIuLi9jb2x1bW4vY29sdW1uLWRlZi5pZlwiO1xuaW1wb3J0IHsgRmlsdGVyRnVuY3Rpb24gfSBmcm9tIFwiLi4vLi4vY29tbW9uL2ZpbHRlci1mdW5jdGlvblwiO1xuaW1wb3J0IHsgU29ydGVyU2VydmljZSB9IGZyb20gXCIuLi8uLi8uLi9zZXJ2aWNlL3NvcnRlci5zZXJ2aWNlXCI7XG5pbXBvcnQgeyBTb3J0SXRlbSB9IGZyb20gXCIuLi8uLi9jb21tb24vc29ydC1pdGVtXCI7XG5cbmV4cG9ydCBjbGFzcyBBcmVhTW9kZWxUcmVlPFM+IGV4dGVuZHMgQWJzdHJhY3RBcmVhTW9kZWw8VHJlZVJvdzxTPj4ge1xuXG4gIHByb3RlY3RlZCByZWFkb25seSBwcm9wZXJ0aWVzOiBzdHJpbmdbXTtcbiAgcHJvdGVjdGVkIHNvcnRlclNlcnZpY2U6IFNvcnRlclNlcnZpY2UgPSBuZXcgU29ydGVyU2VydmljZSgpO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgc2VydmljZSA9IG5ldyBUcmVlUm93U2VydmljZSgpO1xuICBwcml2YXRlIGZpbHRlcmVkRmxhdHRlblJvd3M6IFRyZWVSb3c8Uz5bXTtcbiAgcHJpdmF0ZSBmbGF0dGVuUm93czogVHJlZVJvdzxTPltdO1xuICBwcml2YXRlIGxhc3RQcmVkaWN0Rm4/OiBGaWx0ZXJGdW5jdGlvbjxhbnk+O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBvdmVycmlkZSBhcmVhSWRlbnQ6IEFyZWFJZGVudCxcbiAgICBwdWJsaWMgcmVhZG9ubHkgcm93czogVHJlZVJvdzxTPltdLFxuICAgIHB1YmxpYyBvdmVycmlkZSAgZGVmYXVsdFJvd0hlaWdodDogbnVtYmVyLFxuICAgIHByb3RlY3RlZCBvdmVycmlkZSBjb2x1bW5EZWZzOiBDb2x1bW5EZWZJZltdID0gW11cbiAgKSB7XG4gICAgc3VwZXIoYXJlYUlkZW50LCBjb2x1bW5EZWZzLCBkZWZhdWx0Um93SGVpZ2h0KTtcbiAgICB0aGlzLnByb3BlcnRpZXMgPSBjb2x1bW5EZWZzLm1hcChkZWYgPT4gZGVmLnByb3BlcnR5KTtcbiAgICB0aGlzLmZsYXR0ZW5Sb3dzID0gdGhpcy5zZXJ2aWNlLmZsYXR0ZW5UcmVlKHJvd3MpO1xuICAgIHRoaXMuZmlsdGVyZWRGbGF0dGVuUm93cyA9IFsuLi50aGlzLmZsYXR0ZW5Sb3dzXTtcbiAgfVxuXG4gIG92ZXJyaWRlIGNoYW5nZUNvbHVtbk9yZGVyKHNvdXJjZUNvbHVtbkluZGV4OiBudW1iZXIsIHRhcmdldENvbHVtbkluZGV4OiBudW1iZXIpOiB2b2lkIHtcbiAgICAvLyAgbm90IHRoaXMhIHRoaXMuYXJyYXlNb3ZlKHRoaXMuY29sdW1uRGVmcy4uLilcbiAgICB0aGlzLmFycmF5TW92ZSh0aGlzLnByb3BlcnRpZXMsIHNvdXJjZUNvbHVtbkluZGV4LCB0YXJnZXRDb2x1bW5JbmRleCk7XG4gICAgc3VwZXIuY2hhbmdlQ29sdW1uT3JkZXIoc291cmNlQ29sdW1uSW5kZXgsIHRhcmdldENvbHVtbkluZGV4KTtcbiAgfVxuXG4gIHJlY2FsY1Zpc2libGVUcmVlUm93cygpIHtcbiAgICB0aGlzLmZpbHRlcmVkRmxhdHRlblJvd3MgPSB0aGlzLnNlcnZpY2UuZmxhdHRlblRyZWUodGhpcy5yb3dzKTtcbiAgfVxuXG4gIGdldEZpbHRlcmVkRmxhdHRlblJvd3MoKTogVHJlZVJvdzxTPltdIHtcbiAgICByZXR1cm4gdGhpcy5maWx0ZXJlZEZsYXR0ZW5Sb3dzO1xuICB9XG5cbiAgZ2V0Um93Q291bnQoKTogbnVtYmVyIHtcbiAgICBsZXQgbiA9IDA7XG4gICAgZm9yIChjb25zdCByIG9mIHRoaXMuZmlsdGVyZWRGbGF0dGVuUm93cykge1xuICAgICAgaWYgKHRoaXMuc2VydmljZS5pc1Zpc2libGUocikpIHtcbiAgICAgICAgbisrO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbjtcbiAgfVxuXG4gIGdldFZhbHVlQXQocm93SW5kZXg6IG51bWJlciwgY29sdW1uSW5kZXg6IG51bWJlcik6IGFueSB7XG4gICAgY29uc3Qgcm93ID0gdGhpcy5nZXRSb3dCeUluZGV4KHJvd0luZGV4KTtcbiAgICBpZiAocm93KSB7XG4gICAgICBjb25zdCBwcm9wID0gdGhpcy5wcm9wZXJ0aWVzW2NvbHVtbkluZGV4XTtcbiAgICAgIGlmIChwcm9wKSB7XG4gICAgICAgIGlmIChwcm9wLmluY2x1ZGVzKFwiLlwiKSkge1xuICAgICAgICAgIHJldHVybiB0aGlzLmdldFByb3BlcnR5VmFsdWUocm93LmRhdGEsIHByb3Auc3BsaXQoXCIuXCIpKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIHJldHVybiByb3cuZGF0YVtwcm9wXTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIFwiXCI7XG4gIH1cblxuICBnZXRSb3dIZWlnaHQoX3Jvd0luZGV4OiBudW1iZXIpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLmRlZmF1bHRSb3dIZWlnaHQ7XG4gIH1cblxuICBvdmVycmlkZSBnZXRDdXN0b21DbGFzc2VzQXQocm93SW5kZXg6IG51bWJlciwgX2NvbHVtbkluZGV4OiBudW1iZXIpOiBzdHJpbmdbXSB7XG4gICAgY29uc3Qgcm93ID0gdGhpcy5maWx0ZXJlZEZsYXR0ZW5Sb3dzW3Jvd0luZGV4XTtcbiAgICByZXR1cm4gW1wiZ2UtdGFibGUtdHJlZS1jZWxsXCIsIFwiZ2UtdGFibGUtdHJlZS1kZWVwLVwiICsgcm93LmRlZXBdO1xuICB9XG5cbiAgb3ZlcnJpZGUgZ2V0Um93QnlJbmRleChpZHg6IG51bWJlcik6IFRyZWVSb3c8Uz4gfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLmZpbHRlcmVkRmxhdHRlblJvd3NbaWR4XTtcbiAgfVxuXG4gIGdldFZhbHVlQnlUKHQ6IFMsIHByb3BlcnR5OiBzdHJpbmcpIHtcbiAgICBpZiAocHJvcGVydHkuaW5jbHVkZXMoXCIuXCIpKSB7XG4gICAgICByZXR1cm4gdGhpcy5nZXRQcm9wZXJ0eVZhbHVlKHQsIHByb3BlcnR5LnNwbGl0KFwiLlwiKSk7XG4gICAgfVxuICAgIC8vIEB0cy1pZ25vcmVcbiAgICByZXR1cm4gdFtwcm9wZXJ0eV07XG4gIH1cblxuICBleHRlcm5hbEZpbHRlckNoYW5nZWQ8Uz4ocHJlZGljdEZuOiBGaWx0ZXJGdW5jdGlvbjxTPik6IHZvaWQge1xuICAgIHRoaXMubGFzdFByZWRpY3RGbiA9IHByZWRpY3RGbjtcbiAgICB0aGlzLmRvRmlsdGVyaW5nKCk7XG4gIH1cblxuICBvdmVycmlkZSBkb1NvcnQoc29ydEl0ZW1zOiBTb3J0SXRlbVtdKTogYm9vbGVhbiB7XG4gICAgY29uc3QgeyBjb2x1bW5JbmRleCwgc29ydFN0YXRlIH0gPSBzb3J0SXRlbXNbc29ydEl0ZW1zLmxlbmd0aCAtIDFdO1xuICAgIGNvbnN0IGYgPSBzb3J0U3RhdGUgPT09IFwiYXNjXCIgPyAxIDpcbiAgICAgIHNvcnRTdGF0ZSA9PT0gXCJkZXNjXCIgPyAtMSA6IDA7XG5cbiAgICBjb25zdCBwcm9wZXJ0eSA9IHRoaXMucHJvcGVydGllc1tjb2x1bW5JbmRleF07XG4gICAgdGhpcy50cmVlU29ydCh0aGlzLnJvd3MsIHByb3BlcnR5LCBmKTtcblxuICAgIHRoaXMuZmxhdHRlblJvd3MgPSB0aGlzLnNlcnZpY2UuZmxhdHRlblRyZWUodGhpcy5yb3dzKTtcbiAgICB0aGlzLmZpbHRlcmVkRmxhdHRlblJvd3MgPSBbLi4udGhpcy5mbGF0dGVuUm93c107XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICB0b2dnbGVFeHBhbmRDb2xsYXBzZUFsbChleHBhbmRlZDogYm9vbGVhbikge1xuICAgIHRoaXMuZXhwYW5kQWxsUmVjdXJzaXZlKHRoaXMucm93cywgZXhwYW5kZWQpO1xuXG4gICAgdGhpcy5mbGF0dGVuUm93cyA9IHRoaXMuc2VydmljZS5mbGF0dGVuVHJlZSh0aGlzLnJvd3MpO1xuICAgIHRoaXMuZG9GaWx0ZXJpbmcoKTtcbiAgfVxuXG4gIHNldEFsbFBhcmVudHNPayhpdGVtOiBUcmVlUm93PGFueT4pIHtcbiAgICBpZiAoaXRlbS5wYXJlbnQpIHtcbiAgICAgIGl0ZW0ucGFyZW50LmtlZXAgPSB0cnVlO1xuICAgICAgdGhpcy5zZXRBbGxQYXJlbnRzT2soaXRlbS5wYXJlbnQpO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBvdmVycmlkZSBzZXRWYWx1ZShyb3dJbmRleDogbnVtYmVyLCBjb2x1bW5JbmRleDogbnVtYmVyLCB2YWx1ZTogYW55KTogYm9vbGVhbiB7XG4gICAgY29uc3QgZWRpdElucHV0UGlwZSA9IHRoaXMuY29sdW1uRGVmc1tjb2x1bW5JbmRleF0/LmVkaXRJbnB1dFBpcGU7XG4gICAgaWYgKGVkaXRJbnB1dFBpcGUpIHtcbiAgICAgIHZhbHVlID0gZWRpdElucHV0UGlwZSh2YWx1ZSwgcm93SW5kZXgsIGNvbHVtbkluZGV4KTtcbiAgICB9XG4gICAgY29uc3QgdHJlZVJvdzogVHJlZVJvdzxTPiB8IHVuZGVmaW5lZCA9IHRoaXMuZ2V0Um93QnlJbmRleChyb3dJbmRleCk7XG4gICAgaWYgKHRyZWVSb3cpIHtcbiAgICAgIGNvbnN0IHJvdzogUyA9IHRyZWVSb3cuZGF0YTtcbiAgICAgIGNvbnN0IHByb3BlcnR5ID0gdGhpcy5jb2x1bW5EZWZzW2NvbHVtbkluZGV4XS5wcm9wZXJ0eTtcbiAgICAgIGlmIChwcm9wZXJ0eS5pbmNsdWRlcyhcIi5cIikpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2V0UHJvcGVydHlWYWx1ZShyb3csIHByb3BlcnR5LnNwbGl0KFwiLlwiKSwgdmFsdWUpO1xuICAgICAgfVxuICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgcm93W3Byb3BlcnR5XSA9IHZhbHVlO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZW5lcmljVHJlZVRhYmxlU29ydENvbXBhcmF0b3IocHJvcGVydHk6IHN0cmluZywgZjogbnVtYmVyKSB7XG4gICAgcmV0dXJuIChhOiBUcmVlUm93PFM+LCBiOiBUcmVlUm93PFM+KSA9PiB7XG4gICAgICBjb25zdCB2YSA9IHRoaXMuZ2V0VmFsdWVCeVQoYS5kYXRhLCBwcm9wZXJ0eSk7XG4gICAgICBjb25zdCB2YiA9IHRoaXMuZ2V0VmFsdWVCeVQoYi5kYXRhLCBwcm9wZXJ0eSk7XG4gICAgICByZXR1cm4gdGhpcy5zb3J0ZXJTZXJ2aWNlLmdlbmVyaWNTb3J0Q29tcGFyYXRvcih2YSwgdmIsIGYpO1xuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGV4cGFuZEFsbFJlY3Vyc2l2ZShhcnI6IFRyZWVSb3c8Uz5bXSwgZXhwYW5kZWQ6IGJvb2xlYW4pIHtcbiAgICBmb3IgKGNvbnN0IHJvdyBvZiBhcnIpIHtcbiAgICAgIHJvdy5leHBhbmRlZCA9IGV4cGFuZGVkO1xuICAgICAgaWYgKHJvdy5jaGlsZHJlbikge1xuICAgICAgICB0aGlzLmV4cGFuZEFsbFJlY3Vyc2l2ZShyb3cuY2hpbGRyZW4sIGV4cGFuZGVkKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGRvRmlsdGVyaW5nKCkge1xuICAgIGlmICghdGhpcy5sYXN0UHJlZGljdEZuKSB7XG4gICAgICB0aGlzLmZpbHRlcmVkRmxhdHRlblJvd3MgPSBbLi4uKHRoaXMuZmxhdHRlblJvd3MgPyB0aGlzLmZsYXR0ZW5Sb3dzIDogW10pXTtcbiAgICB9IGVsc2Uge1xuXG4gICAgICBpZiAoIXRoaXMuZmxhdHRlblJvd3MpIHtcbiAgICAgICAgdGhpcy5mbGF0dGVuUm93cyA9IFtdO1xuICAgICAgfVxuXG4gICAgICBsZXQgbWF4RGVlcCA9IDA7XG4gICAgICB0aGlzLmZsYXR0ZW5Sb3dzLmZvckVhY2godiA9PiB7XG4gICAgICAgIG1heERlZXAgPSBNYXRoLm1heChtYXhEZWVwLCB2LmRlZXApO1xuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IG9rUm93cyA9IHRoaXMuZmxhdHRlblJvd3MuZmlsdGVyKFxuICAgICAgICAodmFsdWUsIGluZGV4LCBhcnJheSkgPT4ge1xuICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICByZXR1cm4gdGhpcy5sYXN0UHJlZGljdEZuKHZhbHVlLCBpbmRleCwgYXJyYXkpO1xuICAgICAgICB9XG4gICAgICApO1xuICAgICAgdGhpcy5mbGF0dGVuUm93cy5mb3JFYWNoKHYgPT4gdi5rZWVwID0gZmFsc2UpO1xuICAgICAgdGhpcy5mbGF0dGVuUm93cy5mb3JFYWNoKHYgPT4ge1xuICAgICAgICBpZiAob2tSb3dzLmluY2x1ZGVzKHYpKSB7XG4gICAgICAgICAgdi5rZWVwID0gdHJ1ZTtcbiAgICAgICAgICB0aGlzLnNldEFsbFBhcmVudHNPayh2KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuZmlsdGVyZWRGbGF0dGVuUm93cyA9IHRoaXMuZmxhdHRlblJvd3MuZmlsdGVyKFxuICAgICAgICAodmFsdWUsIF9pbmRleCwgX2FycmF5KSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHZhbHVlLmtlZXA7XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRQcm9wZXJ0eVZhbHVlKG86IGFueSwgcHJvcHM6IHN0cmluZ1tdKTogYW55IHtcbiAgICBjb25zdCBwcm9wID0gcHJvcHMuc2hpZnQoKTtcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgbGV0IG8yID0gb1twcm9wXTtcbiAgICBpZiAobzIgJiYgcHJvcHMubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gdGhpcy5nZXRQcm9wZXJ0eVZhbHVlKG8yLCBwcm9wcyk7XG4gICAgfVxuICAgIHJldHVybiBvMjtcbiAgfVxuXG4gIHByaXZhdGUgdHJlZVNvcnQocm93czogVHJlZVJvdzxTPltdLCBwcm9wZXJ0eTogc3RyaW5nLCBmOiBudW1iZXIpIHtcbiAgICByb3dzLnNvcnQodGhpcy5nZW5lcmljVHJlZVRhYmxlU29ydENvbXBhcmF0b3IocHJvcGVydHksIGYpKTtcbiAgICBmb3IgKGNvbnN0IHJvdyBvZiByb3dzKSB7XG4gICAgICBpZiAocm93LmNoaWxkcmVuKSB7XG4gICAgICAgIHRoaXMudHJlZVNvcnQocm93LmNoaWxkcmVuLCBwcm9wZXJ0eSwgZik7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0=