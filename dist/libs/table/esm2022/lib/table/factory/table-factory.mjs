import { DefaultRowHeights } from "../data/options/default-row-heights";
import { ColumnDef } from "../data/tablemodel/column/column-def";
import { px200 } from "../data/common/sizes";
import { AreaModelArrayOfArrays } from "../data/tablemodel/areamodel/area-model-array-of-arrays";
import { AreaModelHidden } from "../data/tablemodel/areamodel/area-model-hidden";
import { TreeRow } from "../data/common/tree-row";
import { AreaModelTree } from "../data/tablemodel/areamodel/area-model-tree";
import { TreeCheckboxModel } from "../checkbox/tree-checkbox-model";
import { TableModel } from "../data/tablemodel/table-model";
import { AreaModelObjectArrayWithColumndefs } from "../data/tablemodel/areamodel/area-model-object-array-with-columndefs";
import { TableOptions } from "../data/options/table-options";
export class TableFactory {
    static createTableModel(p) {
        if (p.defaultRowHeights === undefined) {
            if (p.tableOptions?.defaultRowHeights) {
                p.defaultRowHeights = p.tableOptions.defaultRowHeights;
            }
            else {
                p.defaultRowHeights = new DefaultRowHeights();
                if (p.headerAreaModel && "defaultRowHeight" in p.headerAreaModel) {
                    const dh = p.headerAreaModel.defaultRowHeight;
                    if (dh > -1) {
                        p.defaultRowHeights.header = dh;
                    }
                }
                if (p.bodyAreaModel && "defaultRowHeight" in p.bodyAreaModel) {
                    const dh = p.bodyAreaModel.defaultRowHeight;
                    if (dh > -1) {
                        p.defaultRowHeights.body = dh;
                    }
                }
                if (p.footerAreaModel && "defaultRowHeight" in p.footerAreaModel) {
                    const dh = p.footerAreaModel.defaultRowHeight;
                    if (dh > -1) {
                        p.defaultRowHeights.footer = dh;
                    }
                }
            }
        }
        if (p.columnDefs === undefined) {
            if (p.properties?.length) {
                p.columnDefs = p.properties.map(p => new ColumnDef(p, p.toUpperCase(), px200));
            }
            else if (p.rows?.length) {
                p.columnDefs = Object.keys(p.rows[0]).map(p => new ColumnDef(p, p.toUpperCase(), px200));
            }
            else {
                p.columnDefs = [];
            }
        }
        if (p.columnCount === undefined) {
            if (p.columnDefs?.length) {
                p.columnCount = p.columnDefs.length;
            }
            else if (p.headerData?.length) {
                p.columnCount = p.headerData[0].length;
            }
            else if (p.columnSizes?.length) {
                p.columnCount = p.columnSizes?.length;
            }
            else {
                console.warn("Property \"columnCount\" is missing and cannot be derived from other properties.");
            }
        }
        if (!p.headerAreaModel) {
            if (p.headerData?.length) {
                p.headerAreaModel = new AreaModelArrayOfArrays("header", p.headerData, p.defaultRowHeights.header, p.columnDefs);
            }
            else if (p.columnDefs?.length) {
                p.headerAreaModel = new AreaModelArrayOfArrays("header", [p.columnDefs.map(def => def.headerLabel)], p.defaultRowHeights.header, p.columnDefs);
            }
            else {
                p.headerAreaModel = new AreaModelHidden("header");
            }
        }
        if (!p.footerAreaModel) {
            if (p.footerData?.length) {
                p.footerAreaModel = new AreaModelArrayOfArrays("footer", p.footerData, p.defaultRowHeights.footer, p.columnDefs);
            }
            else {
                p.footerAreaModel = new AreaModelHidden("footer");
            }
        }
        if (!p.bodyAreaModel) {
            if (p.rows) {
                if (p.rows?.length && p.rows[0] instanceof TreeRow) {
                    // Tree:
                    const treeRows = p.rows;
                    p.bodyAreaModel = new AreaModelTree("body", treeRows, p.defaultRowHeights.body, p.columnDefs);
                    const checkboxExtraColumnVisible = p.columnDefs[0].property === "CheckboxColumn";
                    if (checkboxExtraColumnVisible || p.tableOptions?.showCheckboxWihoutExtraColumn) {
                        p.bodyAreaModel.rowSelectionModel = new TreeCheckboxModel(treeRows);
                    }
                }
                else {
                    p.bodyAreaModel = new AreaModelObjectArrayWithColumndefs("body", p.rows, p.columnDefs, p.defaultRowHeights.body);
                }
            }
            else if (p.bodyData) {
                p.bodyAreaModel = new AreaModelArrayOfArrays("body", p.bodyData, p.defaultRowHeights.body);
            }
            else {
                p.bodyAreaModel = new AreaModelHidden("body");
            }
        }
        if (p.fixedLeftColumnCount === undefined) {
            p.fixedLeftColumnCount = 0;
        }
        if (p.fixedRightColumnCount === undefined) {
            p.fixedRightColumnCount = 0;
        }
        if (p.rowCheckboxVisible === undefined) {
            p.rowCheckboxVisible = false;
        }
        if (p.overridingColumnWidth === undefined) {
            p.overridingColumnWidth = -1;
        }
        if (!p.getSelectionModel && p.tableOptions?.getSelectionModel) {
            p.getSelectionModel = p.tableOptions?.getSelectionModel;
        }
        // Flat table:
        return new TableModel(p.headerAreaModel, p.bodyAreaModel, p.footerAreaModel, p.fixedLeftColumnCount, p.fixedRightColumnCount, p.rowCheckboxVisible, p.defaultRowHeights, p.columnDefs, p.columnSizes, p.overridingColumnWidth, p.columnCount, p.parentSize, p.getSelectionModel);
    }
    static buildByTypedRowsParam(param) {
        return TableFactory.buildByTypedRows(param.rows ?? [], param.columnDefs, param.tableOptions ?? new TableOptions(), param.fixedLeftColumnCount ?? 0, param.fixedRightColumnCount ?? 0);
    }
    static buildByTypedRows(rows, columnDefs, tableOptions = new TableOptions(), fixedLeftColumnCount = 0, fixedRightColumnCount = 0) {
        const defaultRowHeights = tableOptions.defaultRowHeights;
        const checkboxExtraColumnVisible = columnDefs[0].property === "CheckboxColumn";
        if (rows?.length && rows[0] instanceof TreeRow) {
            // Tree:
            const treeRows = rows;
            const bodyareaModel = new AreaModelTree("body", treeRows, defaultRowHeights.body, columnDefs);
            if (checkboxExtraColumnVisible || tableOptions.showCheckboxWihoutExtraColumn) {
                bodyareaModel.rowSelectionModel = new TreeCheckboxModel(treeRows);
            }
            return TableFactory.createByAreaModelsParam({
                headerAreaModel: new AreaModelArrayOfArrays("header", [columnDefs.map(def => def.headerLabel)], defaultRowHeights.header),
                bodyAreaModel: bodyareaModel,
                footerAreaModel: new AreaModelArrayOfArrays("footer", [], defaultRowHeights.footer),
                columnDefs,
                fixedLeftColumnCount,
                fixedRightColumnCount,
                defaultRowHeights: tableOptions.defaultRowHeights,
                rowCheckboxVisible: false,
                columnSizes: [],
                columnCount: columnDefs.length,
                overridingColumnWidth: -1
            });
        }
        // Flat table:
        return TableFactory.createByObjectArrayParam({
            rows,
            columnDefs,
            fixedLeftColumnCount,
            fixedRightColumnCount,
            defaultRowHeights: tableOptions.defaultRowHeights
        });
    }
    static createByObjectArrayParam(param) {
        const rowCheckboxVisible = param.rowCheckboxVisible !== undefined ? param.rowCheckboxVisible : false;
        return TableFactory.createByObjectArray(param.rows, param.header ?? [], param.footer ?? [], param.fixedLeftColumnCount ?? 0, param.fixedRightColumnCount ?? 0, rowCheckboxVisible, param.defaultRowHeights ?? new DefaultRowHeights(), param.columnDefs ?? [], param.columnSizes ?? []);
    }
    static createByAreaModels(headerAreaModel = new AreaModelHidden(), bodyAreaModel, footerAreaModel = new AreaModelHidden(), fixedLeftColumnCount = 0, fixedRightColumnCount = 0, rowCheckboxVisible = false, defaultRowHeights = new DefaultRowHeights(), columnDefs, columnSizes = [], overridingColumnWidth = -1, columnCount) {
        return new TableModel(headerAreaModel, bodyAreaModel, footerAreaModel, fixedLeftColumnCount, fixedRightColumnCount, rowCheckboxVisible, defaultRowHeights, columnDefs, columnSizes, overridingColumnWidth, columnCount);
    }
    static createByAreaModelsParam(param) {
        return TableFactory.createByAreaModels(param.headerAreaModel ?? new AreaModelHidden(), param.bodyAreaModel, param.footerAreaModel ?? new AreaModelHidden(), param.fixedLeftColumnCount ?? 0, param.fixedRightColumnCount ?? 0, param.rowCheckboxVisible === undefined ? false : param.rowCheckboxVisible, param.defaultRowHeights, param.columnDefs ?? [], param.columnSizes ?? [], param.overridingColumnWidth ?? -1, param.columnCount ?? 0);
    }
    static createByObjectArray(rows, header = [], footer = [], fixedLeftColumnCount = 0, fixedRightColumnCount = 0, rowCheckboxVisible = false, defaultRowHeights = new DefaultRowHeights(), columnDefs, columnSizes = []) {
        let headerAreaModel;
        if (header?.length) {
            headerAreaModel = new AreaModelArrayOfArrays("header", header, defaultRowHeights.header, columnDefs);
        }
        else if (columnDefs?.length) {
            headerAreaModel = new AreaModelArrayOfArrays("header", [columnDefs.map(def => def.headerLabel)], defaultRowHeights.header, columnDefs);
        }
        else {
            headerAreaModel = new AreaModelHidden();
        }
        const footerAreaModel = footer ? new AreaModelArrayOfArrays("footer", footer, defaultRowHeights.footer, columnDefs) : new AreaModelHidden();
        const bodyAreaModel = new AreaModelObjectArrayWithColumndefs("body", rows, columnDefs, defaultRowHeights.body);
        return new TableModel(headerAreaModel, bodyAreaModel, footerAreaModel, fixedLeftColumnCount, fixedRightColumnCount, rowCheckboxVisible, defaultRowHeights, columnDefs, columnSizes);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFibGUtZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvdGFibGUvc3JjL2xpYi90YWJsZS9mYWN0b3J5L3RhYmxlLWZhY3RvcnkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBTUEsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFDeEUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBQ2pFLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUM3QyxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSx5REFBeUQsQ0FBQztBQUNqRyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sZ0RBQWdELENBQUM7QUFDakYsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ2xELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSw4Q0FBOEMsQ0FBQztBQUM3RSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUNwRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFFNUQsT0FBTyxFQUNMLGtDQUFrQyxFQUNuQyxNQUFNLHNFQUFzRSxDQUFDO0FBQzlFLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUc3RCxNQUFNLE9BQU8sWUFBWTtJQUVoQixNQUFNLENBQUMsZ0JBQWdCLENBQUMsQ0FxQjdCO1FBRUEsSUFBSSxDQUFDLENBQUMsaUJBQWlCLEtBQUssU0FBUyxFQUFFO1lBQ3JDLElBQUksQ0FBQyxDQUFDLFlBQVksRUFBRSxpQkFBaUIsRUFBRTtnQkFDckMsQ0FBQyxDQUFDLGlCQUFpQixHQUFHLENBQUMsQ0FBQyxZQUFZLENBQUMsaUJBQWlCLENBQUM7YUFDeEQ7aUJBQU07Z0JBQ0wsQ0FBQyxDQUFDLGlCQUFpQixHQUFHLElBQUksaUJBQWlCLEVB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QWlCLENBQUMsTUFBTSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1NBQzlHO2FBQU0sSUFBSSxVQUFVLEVBQUUsTUFBTSxFQUFFO1lBQzdCLGVBQWUsR0FBRyxJQUFJLHNCQUFzQixDQUFTLFFBQVEsRUFBRSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUMsRUFBRSxpQkFBaUIsQ0FBQyxNQUFNLEVBQUUsVUFBVSxDQUFDLENBQUM7U0FDaEo7YUFBTTtZQUNMLGVBQWUsR0FBRyxJQUFJLGVBQWUsRUFBRSxDQUFDO1NBQ3pDO1FBQ0QsTUFBTSxlQUFlLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLHNCQUFzQixDQUFTLFFBQVEsRUFBRSxNQUFNLEVBQUUsaUJBQWlCLENBQUMsTUFBTSxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLGVBQWUsRUFBRSxDQUFDO1FBQ3BKLE1BQU0sYUFBYSxHQUFHLElBQUksa0NBQWtDLENBQUksTUFBTSxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFbEgsT0FBTyxJQUFJLFVBQVUsQ0FDbkIsZUFBZSxFQUNmLGFBQWEsRUFDYixlQUFlLEVBQ2Ysb0JBQW9CLEVBQ3BCLHFCQUFxQixFQUNyQixrQkFBa0IsRUFDbEIsaUJBQWlCLEVBQ2pCLFVBQVUsRUFDVixXQUFXLENBQ1osQ0FBQztJQUNKLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFyZWFNb2RlbElmIH0gZnJvbSBcIi4uL2RhdGEvdGFibGVtb2RlbC9hcmVhbW9kZWwvYXJlYS1tb2RlbC5pZlwiO1xuaW1wb3J0IHsgRGVmYXVsdFJvd0hlaWdodHNJZiB9IGZyb20gXCIuLi9kYXRhL29wdGlvbnMvZGVmYXVsdC1yb3ctaGVpZ2h0cy5pZlwiO1xuaW1wb3J0IHsgQ29sdW1uRGVmSWYgfSBmcm9tIFwiLi4vZGF0YS90YWJsZW1vZGVsL2NvbHVtbi9jb2x1bW4tZGVmLmlmXCI7XG5pbXBvcnQgeyBHZXRUIH0gZnJvbSBcIi4uL2RhdGEvY29tbW9uL2dldC10XCI7XG5pbXBvcnQgeyBUYWJsZU9wdGlvbnNJZiB9IGZyb20gXCIuLi9kYXRhL29wdGlvbnMvdGFibGUtb3B0aW9ucy5pZlwiO1xuaW1wb3J0IHsgVGFibGVNb2RlbElmIH0gZnJvbSBcIi4uL2RhdGEvdGFibGVtb2RlbC90YWJsZS1tb2RlbC5pZlwiO1xuaW1wb3J0IHsgRGVmYXVsdFJvd0hlaWdodHMgfSBmcm9tIFwiLi4vZGF0YS9vcHRpb25zL2RlZmF1bHQtcm93LWhlaWdodHNcIjtcbmltcG9ydCB7IENvbHVtbkRlZiB9IGZyb20gXCIuLi9kYXRhL3RhYmxlbW9kZWwvY29sdW1uL2NvbHVtbi1kZWZcIjtcbmltcG9ydCB7IHB4MjAwIH0gZnJvbSBcIi4uL2RhdGEvY29tbW9uL3NpemVzXCI7XG5pbXBvcnQgeyBBcmVhTW9kZWxBcnJheU9mQXJyYXlzIH0gZnJvbSBcIi4uL2RhdGEvdGFibGVtb2RlbC9hcmVhbW9kZWwvYXJlYS1tb2RlbC1hcnJheS1vZi1hcnJheXNcIjtcbmltcG9ydCB7IEFyZWFNb2RlbEhpZGRlbiB9IGZyb20gXCIuLi9kYXRhL3RhYmxlbW9kZWwvYXJlYW1vZGVsL2FyZWEtbW9kZWwtaGlkZGVuXCI7XG5pbXBvcnQgeyBUcmVlUm93IH0gZnJvbSBcIi4uL2RhdGEvY29tbW9uL3RyZWUtcm93XCI7XG5pbXBvcnQgeyBBcmVhTW9kZWxUcmVlIH0gZnJvbSBcIi4uL2RhdGEvdGFibGVtb2RlbC9hcmVhbW9kZWwvYXJlYS1tb2RlbC10cmVlXCI7XG5pbXBvcnQgeyBUcmVlQ2hlY2tib3hNb2RlbCB9IGZyb20gXCIuLi9jaGVja2JveC90cmVlLWNoZWNrYm94LW1vZGVsXCI7XG5pbXBvcnQgeyBUYWJsZU1vZGVsIH0gZnJvbSBcIi4uL2RhdGEvdGFibGVtb2RlbC90YWJsZS1tb2RlbFwiO1xuaW1wb3J0IHsgU2VsZWN0aW9uTW9kZWxJZiB9IGZyb20gXCIuLi9zZWxlY3Rpb24vc2VsZWN0aW9uLW1vZGVsLmlmXCI7XG5pbXBvcnQge1xuICBBcmVhTW9kZWxPYmplY3RBcnJheVdpdGhDb2x1bW5kZWZzXG59IGZyb20gXCIuLi9kYXRhL3RhYmxlbW9kZWwvYXJlYW1vZGVsL2FyZWEtbW9kZWwtb2JqZWN0LWFycmF5LXdpdGgtY29sdW1uZGVmc1wiO1xuaW1wb3J0IHsgVGFibGVPcHRpb25zIH0gZnJvbSBcIi4uL2RhdGEvb3B0aW9ucy90YWJsZS1vcHRpb25zXCI7XG5cblxuZXhwb3J0IGNsYXNzIFRhYmxlRmFjdG9yeSB7XG5cbiAgcHVibGljIHN0YXRpYyBjcmVhdGVUYWJsZU1vZGVsKHA6IFBhcnRpYWw8e1xuICAgIGhlYWRlckFyZWFNb2RlbDogQXJlYU1vZGVsSWYsXG4gICAgYm9keUFyZWFNb2RlbDogQXJlYU1vZGVsSWYsXG4gICAgZm9vdGVyQXJlYU1vZGVsOiBBcmVhTW9kZWxJZixcbiAgICBmaXhlZExlZnRDb2x1bW5Db3VudDogbnVtYmVyLFxuICAgIGZpeGVkUmlnaHRDb2x1bW5Db3VudDogbnVtYmVyLFxuICAgIHJvd0NoZWNrYm94VmlzaWJsZTogYm9vbGVhbixcbiAgICBkZWZhdWx0Um93SGVpZ2h0czogRGVmYXVsdFJvd0hlaWdodHNJZixcbiAgICBjb2x1bW5EZWZzOiBDb2x1bW5EZWZJZltdLFxuICAgIGNvbHVtblNpemVzOiBudW1iZXJbXSxcbiAgICBvdmVycmlkaW5nQ29sdW1uV2lkdGg6IG51bWJlcixcbiAgICBjb2x1bW5Db3VudDogbnVtYmVyLFxuICAgIHBhcmVudFNpemU6IG51bWJlcixcbiAgICBnZXRTZWxlY3Rpb25Nb2RlbDogR2V0VDxTZWxlY3Rpb25Nb2RlbElmPixcbiAgICByb3dzOiBhbnlbXSxcbiAgICBwcm9wZXJ0aWVzOiBzdHJpbmdbXSxcbiAgICBib2R5RGF0YTogYW55W11bXSxcbiAgICBoZWFkZXJEYXRhOiBzdHJpbmdbXVtdLCAvLyBtdWx0aS1saW5lIGhlYWRlclxuICAgIGZvb3RlckRhdGE6IHN0cmluZ1tdW10sIC8vIG11bHRpLWxpbmUgZm9vdGVyRGF0YVxuICAgIHRhYmxlT3B0aW9uczogVGFibGVPcHRpb25zSWZcblxuICB9Pik6IFRhYmxlTW9kZWxJZiB7XG5cbiAgICBpZiAocC5kZWZhdWx0Um93SGVpZ2h0cyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBpZiAocC50YWJsZU9wdGlvbnM/LmRlZmF1bHRSb3dIZWlnaHRzKSB7XG4gICAgICAgIHAuZGVmYXVsdFJvd0hlaWdodHMgPSBwLnRhYmxlT3B0aW9ucy5kZWZhdWx0Um93SGVpZ2h0cztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHAuZGVmYXVsdFJvd0hlaWdodHMgPSBuZXcgRGVmYXVsdFJvd0hlaWdodHMoKTtcblxuICAgICAgICBpZiAocC5oZWFkZXJBcmVhTW9kZWwgJiYgXCJkZWZhdWx0Um93SGVpZ2h0XCIgaW4gcC5oZWFkZXJBcmVhTW9kZWwpIHtcbiAgICAgICAgICBjb25zdCBkaCA9IHAuaGVhZGVyQXJlYU1vZGVsLmRlZmF1bHRSb3dIZWlnaHQgYXMgbnVtYmVyO1xuICAgICAgICAgIGlmIChkaCA+IC0xKSB7XG4gICAgICAgICAgICBwLmRlZmF1bHRSb3dIZWlnaHRzLmhlYWRlciA9IGRoO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChwLmJvZHlBcmVhTW9kZWwgJiYgXCJkZWZhdWx0Um93SGVpZ2h0XCIgaW4gcC5ib2R5QXJlYU1vZGVsKSB7XG4gICAgICAgICAgY29uc3QgZGggPSBwLmJvZHlBcmVhTW9kZWwuZGVmYXVsdFJvd0hlaWdodCBhcyBudW1iZXI7XG4gICAgICAgICAgaWYgKGRoID4gLTEpIHtcbiAgICAgICAgICAgIHAuZGVmYXVsdFJvd0hlaWdodHMuYm9keSA9IGRoO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChwLmZvb3RlckFyZWFNb2RlbCAmJiBcImRlZmF1bHRSb3dIZWlnaHRcIiBpbiBwLmZvb3RlckFyZWFNb2RlbCkge1xuICAgICAgICAgIGNvbnN0IGRoID0gcC5mb290ZXJBcmVhTW9kZWwuZGVmYXVsdFJvd0hlaWdodCBhcyBudW1iZXI7XG4gICAgICAgICAgaWYgKGRoID4gLTEpIHtcbiAgICAgICAgICAgIHAuZGVmYXVsdFJvd0hlaWdodHMuZm9vdGVyID0gZGg7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHAuY29sdW1uRGVmcyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBpZiAocC5wcm9wZXJ0aWVzPy5sZW5ndGgpIHtcbiAgICAgICAgcC5jb2x1bW5EZWZzID0gcC5wcm9wZXJ0aWVzLm1hcChwID0+IG5ldyBDb2x1bW5EZWYocCwgcC50b1VwcGVyQ2FzZSgpLCBweDIwMCkpO1xuICAgICAgfSBlbHNlIGlmIChwLnJvd3M/Lmxlbmd0aCkge1xuICAgICAgICBwLmNvbHVtbkRlZnMgPSBPYmplY3Qua2V5cyhwLnJvd3NbMF0pLm1hcChwID0+IG5ldyBDb2x1bW5EZWYocCwgcC50b1VwcGVyQ2FzZSgpLCBweDIwMCkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcC5jb2x1bW5EZWZzID0gW107XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHAuY29sdW1uQ291bnQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgaWYgKHAuY29sdW1uRGVmcz8ubGVuZ3RoKSB7XG4gICAgICAgIHAuY29sdW1uQ291bnQgPSBwLmNvbHVtbkRlZnMubGVuZ3RoO1xuICAgICAgfSBlbHNlIGlmIChwLmhlYWRlckRhdGE/Lmxlbmd0aCkge1xuICAgICAgICBwLmNvbHVtbkNvdW50ID0gcC5oZWFkZXJEYXRhWzBdLmxlbmd0aDtcbiAgICAgIH0gZWxzZSBpZiAocC5jb2x1bW5TaXplcz8ubGVuZ3RoKSB7XG4gICAgICAgIHAuY29sdW1uQ291bnQgPSBwLmNvbHVtblNpemVzPy5sZW5ndGg7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLndhcm4oXCJQcm9wZXJ0eSBcXFwiY29sdW1uQ291bnRcXFwiIGlzIG1pc3NpbmcgYW5kIGNhbm5vdCBiZSBkZXJpdmVkIGZyb20gb3RoZXIgcHJvcGVydGllcy5cIik7XG4gICAgICB9XG4gICAgfVxuXG5cbiAgICBpZiAoIXAuaGVhZGVyQXJlYU1vZGVsKSB7XG4gICAgICBpZiAocC5oZWFkZXJEYXRhPy5sZW5ndGgpIHtcbiAgICAgICAgcC5oZWFkZXJBcmVhTW9kZWwgPSBuZXcgQXJlYU1vZGVsQXJyYXlPZkFycmF5czxzdHJpbmc+KFxuICAgICAgICAgIFwiaGVhZGVyXCIsXG4gICAgICAgICAgcC5oZWFkZXJEYXRhLFxuICAgICAgICAgIHAuZGVmYXVsdFJvd0hlaWdodHMuaGVhZGVyLFxuICAgICAgICAgIHAuY29sdW1uRGVmc1xuICAgICAgICApO1xuICAgICAgfSBlbHNlIGlmIChwLmNvbHVtbkRlZnM/Lmxlbmd0aCkge1xuICAgICAgICBwLmhlYWRlckFyZWFNb2RlbCA9IG5ldyBBcmVhTW9kZWxBcnJheU9mQXJyYXlzPHN0cmluZz4oXG4gICAgICAgICAgXCJoZWFkZXJcIixcbiAgICAgICAgICBbcC5jb2x1bW5EZWZzLm1hcChkZWYgPT4gZGVmLmhlYWRlckxhYmVsKV0sXG4gICAgICAgICAgcC5kZWZhdWx0Um93SGVpZ2h0cy5oZWFkZXIsXG4gICAgICAgICAgcC5jb2x1bW5EZWZzXG4gICAgICAgICk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBwLmhlYWRlckFyZWFNb2RlbCA9IG5ldyBBcmVhTW9kZWxIaWRkZW4oXCJoZWFkZXJcIik7XG4gICAgICB9XG4gICAgfVxuICAgIGlmICghcC5mb290ZXJBcmVhTW9kZWwpIHtcbiAgICAgIGlmIChwLmZvb3RlckRhdGE/Lmxlbmd0aCkge1xuICAgICAgICBwLmZvb3RlckFyZWFNb2RlbCA9IG5ldyBBcmVhTW9kZWxBcnJheU9mQXJyYXlzPHN0cmluZz4oXG4gICAgICAgICAgXCJmb290ZXJcIixcbiAgICAgICAgICBwLmZvb3RlckRhdGEsXG4gICAgICAgICAgcC5kZWZhdWx0Um93SGVpZ2h0cy5mb290ZXIsXG4gICAgICAgICAgcC5jb2x1bW5EZWZzXG4gICAgICAgICk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBwLmZvb3RlckFyZWFNb2RlbCA9IG5ldyBBcmVhTW9kZWxIaWRkZW4oXCJmb290ZXJcIik7XG4gICAgICB9XG4gICAgfVxuICAgIGlmICghcC5ib2R5QXJlYU1vZGVsKSB7XG4gICAgICBpZiAocC5yb3dzKSB7XG5cbiAgICAgICAgaWYgKHAucm93cz8ubGVuZ3RoICYmIHAucm93c1swXSBpbnN0YW5jZW9mIFRyZWVSb3cpIHtcbiAgICAgICAgICAvLyBUcmVlOlxuICAgICAgICAgIGNvbnN0IHRyZWVSb3dzID0gcC5yb3dzIGFzIFRyZWVSb3c8YW55PltdO1xuICAgICAgICAgIHAuYm9keUFyZWFNb2RlbCA9IG5ldyBBcmVhTW9kZWxUcmVlKFxuICAgICAgICAgICAgXCJib2R5XCIsXG4gICAgICAgICAgICB0cmVlUm93cyxcbiAgICAgICAgICAgIHAuZGVmYXVsdFJvd0hlaWdodHMuYm9keSxcbiAgICAgICAgICAgIHAuY29sdW1uRGVmc1xuICAgICAgICAgICk7XG4gICAgICAgICAgY29uc3QgY2hlY2tib3hFeHRyYUNvbHVtblZpc2libGUgPSBwLmNvbHVtbkRlZnNbMF0ucHJvcGVydHkgPT09IFwiQ2hlY2tib3hDb2x1bW5cIjtcbiAgICAgICAgICBpZiAoY2hlY2tib3hFeHRyYUNvbHVtblZpc2libGUgfHwgcC50YWJsZU9wdGlvbnM/LnNob3dDaGVja2JveFdpaG91dEV4dHJhQ29sdW1uKSB7XG4gICAgICAgICAgICBwLmJvZHlBcmVhTW9kZWwucm93U2VsZWN0aW9uTW9kZWwgPSBuZXcgVHJlZUNoZWNrYm94TW9kZWwodHJlZVJvd3MpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBwLmJvZHlBcmVhTW9kZWwgPSBuZXcgQXJlYU1vZGVsT2JqZWN0QXJyYXlXaXRoQ29sdW1uZGVmczxhbnk+KFxuICAgICAgICAgICAgXCJib2R5XCIsIHAucm93cywgcC5jb2x1bW5EZWZzLCBwLmRlZmF1bHRSb3dIZWlnaHRzLmJvZHlcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgIH0gZWxzZSBpZiAocC5ib2R5RGF0YSkge1xuICAgICAgICBwLmJvZHlBcmVhTW9kZWwgPSBuZXcgQXJlYU1vZGVsQXJyYXlPZkFycmF5czxhbnk+KFxuICAgICAgICAgIFwiYm9keVwiLCBwLmJvZHlEYXRhLCBwLmRlZmF1bHRSb3dIZWlnaHRzLmJvZHlcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHAuYm9keUFyZWFNb2RlbCA9IG5ldyBBcmVhTW9kZWxIaWRkZW4oXCJib2R5XCIpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChwLmZpeGVkTGVmdENvbHVtbkNvdW50ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHAuZml4ZWRMZWZ0Q29sdW1uQ291bnQgPSAwO1xuICAgIH1cbiAgICBpZiAocC5maXhlZFJpZ2h0Q29sdW1uQ291bnQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcC5maXhlZFJpZ2h0Q29sdW1uQ291bnQgPSAwO1xuICAgIH1cbiAgICBpZiAocC5yb3dDaGVja2JveFZpc2libGUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcC5yb3dDaGVja2JveFZpc2libGUgPSBmYWxzZTtcbiAgICB9XG4gICAgaWYgKHAub3ZlcnJpZGluZ0NvbHVtbldpZHRoID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHAub3ZlcnJpZGluZ0NvbHVtbldpZHRoID0gLTE7XG4gICAgfVxuXG4gICAgaWYgKCFwLmdldFNlbGVjdGlvbk1vZGVsICYmIHAudGFibGVPcHRpb25zPy5nZXRTZWxlY3Rpb25Nb2RlbCkge1xuICAgICAgcC5nZXRTZWxlY3Rpb25Nb2RlbCA9IHAudGFibGVPcHRpb25zPy5nZXRTZWxlY3Rpb25Nb2RlbDtcbiAgICB9XG5cbiAgICAvLyBGbGF0IHRhYmxlOlxuICAgIHJldHVybiBuZXcgVGFibGVNb2RlbChcbiAgICAgIHAuaGVhZGVyQXJlYU1vZGVsLFxuICAgICAgcC5ib2R5QXJlYU1vZGVsLFxuICAgICAgcC5mb290ZXJBcmVhTW9kZWwsXG4gICAgICBwLmZpeGVkTGVmdENvbHVtbkNvdW50LFxuICAgICAgcC5maXhlZFJpZ2h0Q29sdW1uQ291bnQsXG4gICAgICBwLnJvd0NoZWNrYm94VmlzaWJsZSxcbiAgICAgIHAuZGVmYXVsdFJvd0hlaWdodHMsXG4gICAgICBwLmNvbHVtbkRlZnMsXG4gICAgICBwLmNvbHVtblNpemVzLFxuICAgICAgcC5vdmVycmlkaW5nQ29sdW1uV2lkdGgsXG4gICAgICBwLmNvbHVtbkNvdW50LFxuICAgICAgcC5wYXJlbnRTaXplLFxuICAgICAgcC5nZXRTZWxlY3Rpb25Nb2RlbFxuICAgICk7XG4gIH1cblxuICBzdGF0aWMgYnVpbGRCeVR5cGVkUm93c1BhcmFtPFQ+KHBhcmFtOiB7XG4gICAgcm93czogVFtdLFxuICAgIGNvbHVtbkRlZnM6IENvbHVtbkRlZklmW10sXG4gICAgdGFibGVPcHRpb25zPzogVGFibGVPcHRpb25zSWYsXG4gICAgZml4ZWRMZWZ0Q29sdW1uQ291bnQ/OiBudW1iZXIsXG4gICAgZml4ZWRSaWdodENvbHVtbkNvdW50PzogbnVtYmVyXG4gIH0pOiBUYWJsZU1vZGVsSWYge1xuXG4gICAgcmV0dXJuIFRhYmxlRmFjdG9yeS5idWlsZEJ5VHlwZWRSb3dzPFQ+KFxuICAgICAgcGFyYW0ucm93cyA/PyBbXSxcbiAgICAgIHBhcmFtLmNvbHVtbkRlZnMsXG4gICAgICBwYXJhbS50YWJsZU9wdGlvbnMgPz8gbmV3IFRhYmxlT3B0aW9ucygpLFxuICAgICAgcGFyYW0uZml4ZWRMZWZ0Q29sdW1uQ291bnQgPz8gMCxcbiAgICAgIHBhcmFtLmZpeGVkUmlnaHRDb2x1bW5Db3VudCA/PyAwXG4gICAgKTtcbiAgfVxuXG4gIHN0YXRpYyBidWlsZEJ5VHlwZWRSb3dzPFQ+KFxuICAgIHJvd3M6IFRbXSxcbiAgICBjb2x1bW5EZWZzOiBDb2x1bW5EZWZJZltdLFxuICAgIHRhYmxlT3B0aW9uczogVGFibGVPcHRpb25zSWYgPSBuZXcgVGFibGVPcHRpb25zKCksXG4gICAgZml4ZWRMZWZ0Q29sdW1uQ291bnQ6IG51bWJlciA9IDAsXG4gICAgZml4ZWRSaWdodENvbHVtbkNvdW50OiBudW1iZXIgPSAwXG4gICk6IFRhYmxlTW9kZWxJZiB7XG5cbiAgICBjb25zdCBkZWZhdWx0Um93SGVpZ2h0cyA9IHRhYmxlT3B0aW9ucy5kZWZhdWx0Um93SGVpZ2h0cztcbiAgICBjb25zdCBjaGVja2JveEV4dHJhQ29sdW1uVmlzaWJsZSA9IGNvbHVtbkRlZnNbMF0ucHJvcGVydHkgPT09IFwiQ2hlY2tib3hDb2x1bW5cIjtcblxuICAgIGlmIChyb3dzPy5sZW5ndGggJiYgcm93c1swXSBpbnN0YW5jZW9mIFRyZWVSb3cpIHtcbiAgICAgIC8vIFRyZWU6XG4gICAgICBjb25zdCB0cmVlUm93cyA9IHJvd3MgYXMgVHJlZVJvdzxUPltdO1xuICAgICAgY29uc3QgYm9keWFyZWFNb2RlbCA9IG5ldyBBcmVhTW9kZWxUcmVlKFxuICAgICAgICBcImJvZHlcIixcbiAgICAgICAgdHJlZVJvd3MsXG4gICAgICAgIGRlZmF1bHRSb3dIZWlnaHRzLmJvZHksXG4gICAgICAgIGNvbHVtbkRlZnNcbiAgICAgICk7XG4gICAgICBpZiAoY2hlY2tib3hFeHRyYUNvbHVtblZpc2libGUgfHwgdGFibGVPcHRpb25zLnNob3dDaGVja2JveFdpaG91dEV4dHJhQ29sdW1uKSB7XG4gICAgICAgIGJvZHlhcmVhTW9kZWwucm93U2VsZWN0aW9uTW9kZWwgPSBuZXcgVHJlZUNoZWNrYm94TW9kZWwodHJlZVJvd3MpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIFRhYmxlRmFjdG9yeS5jcmVhdGVCeUFyZWFNb2RlbHNQYXJhbSh7XG4gICAgICAgIGhlYWRlckFyZWFNb2RlbDogbmV3IEFyZWFNb2RlbEFycmF5T2ZBcnJheXM8c3RyaW5nPihcImhlYWRlclwiLCBbY29sdW1uRGVmcy5tYXAoZGVmID0+IGRlZi5oZWFkZXJMYWJlbCldLCBkZWZhdWx0Um93SGVpZ2h0cy5oZWFkZXIpLFxuICAgICAgICBib2R5QXJlYU1vZGVsOiBib2R5YXJlYU1vZGVsLFxuICAgICAgICBmb290ZXJBcmVhTW9kZWw6IG5ldyBBcmVhTW9kZWxBcnJheU9mQXJyYXlzPHN0cmluZz4oXCJmb290ZXJcIiwgW10sIGRlZmF1bHRSb3dIZWlnaHRzLmZvb3RlciksXG4gICAgICAgIGNvbHVtbkRlZnMsXG4gICAgICAgIGZpeGVkTGVmdENvbHVtbkNvdW50LFxuICAgICAgICBmaXhlZFJpZ2h0Q29sdW1uQ291bnQsXG4gICAgICAgIGRlZmF1bHRSb3dIZWlnaHRzOiB0YWJsZU9wdGlvbnMuZGVmYXVsdFJvd0hlaWdodHMsXG4gICAgICAgIHJvd0NoZWNrYm94VmlzaWJsZTogZmFsc2UsXG4gICAgICAgIGNvbHVtblNpemVzOiBbXSxcbiAgICAgICAgY29sdW1uQ291bnQ6IGNvbHVtbkRlZnMubGVuZ3RoLFxuICAgICAgICBvdmVycmlkaW5nQ29sdW1uV2lkdGg6IC0xXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBGbGF0IHRhYmxlOlxuICAgIHJldHVybiBUYWJsZUZhY3RvcnkuY3JlYXRlQnlPYmplY3RBcnJheVBhcmFtKHtcbiAgICAgIHJvd3MsXG4gICAgICBjb2x1bW5EZWZzLFxuICAgICAgZml4ZWRMZWZ0Q29sdW1uQ291bnQsXG4gICAgICBmaXhlZFJpZ2h0Q29sdW1uQ291bnQsXG4gICAgICBkZWZhdWx0Um93SGVpZ2h0czogdGFibGVPcHRpb25zLmRlZmF1bHRSb3dIZWlnaHRzXG4gICAgfSk7XG5cbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgY3JlYXRlQnlPYmplY3RBcnJheVBhcmFtPFQ+KHBhcmFtOiB7XG4gICAgcm93czogVFtdLFxuICAgIGhlYWRlcj86IHN0cmluZ1tdW10sXG4gICAgZm9vdGVyPzogc3RyaW5nW11bXSxcbiAgICBmaXhlZExlZnRDb2x1bW5Db3VudD86IG51bWJlcixcbiAgICBmaXhlZFJpZ2h0Q29sdW1uQ291bnQ/OiBudW1iZXIsXG4gICAgcm93Q2hlY2tib3hWaXNpYmxlPzogYm9vbGVhbixcbiAgICBkZWZhdWx0Um93SGVpZ2h0cz86IERlZmF1bHRSb3dIZWlnaHRzSWYsXG4gICAgY29sdW1uRGVmcz86IENvbHVtbkRlZklmW10sXG4gICAgY29sdW1uU2l6ZXM/OiBudW1iZXJbXVxuICB9KSB7XG4gICAgY29uc3Qgcm93Q2hlY2tib3hWaXNpYmxlID0gcGFyYW0ucm93Q2hlY2tib3hWaXNpYmxlICE9PSB1bmRlZmluZWQgPyBwYXJhbS5yb3dDaGVja2JveFZpc2libGUgOiBmYWxzZTtcbiAgICByZXR1cm4gVGFibGVGYWN0b3J5LmNyZWF0ZUJ5T2JqZWN0QXJyYXk8VD4oXG4gICAgICBwYXJhbS5yb3dzLFxuICAgICAgcGFyYW0uaGVhZGVyID8/IFtdLFxuICAgICAgcGFyYW0uZm9vdGVyID8/IFtdLFxuICAgICAgcGFyYW0uZml4ZWRMZWZ0Q29sdW1uQ291bnQgPz8gMCxcbiAgICAgIHBhcmFtLmZpeGVkUmlnaHRDb2x1bW5Db3VudCA/PyAwLFxuICAgICAgcm93Q2hlY2tib3hWaXNpYmxlLFxuICAgICAgcGFyYW0uZGVmYXVsdFJvd0hlaWdodHMgPz8gbmV3IERlZmF1bHRSb3dIZWlnaHRzKCksXG4gICAgICBwYXJhbS5jb2x1bW5EZWZzID8/IFtdLFxuICAgICAgcGFyYW0uY29sdW1uU2l6ZXMgPz8gW11cbiAgICApO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBjcmVhdGVCeUFyZWFNb2RlbHMoXG4gICAgaGVhZGVyQXJlYU1vZGVsOiBBcmVhTW9kZWxJZiA9IG5ldyBBcmVhTW9kZWxIaWRkZW4oKSxcbiAgICBib2R5QXJlYU1vZGVsOiBBcmVhTW9kZWxJZixcbiAgICBmb290ZXJBcmVhTW9kZWw6IEFyZWFNb2RlbElmID0gbmV3IEFyZWFNb2RlbEhpZGRlbigpLFxuICAgIGZpeGVkTGVmdENvbHVtbkNvdW50OiBudW1iZXIgPSAwLFxuICAgIGZpeGVkUmlnaHRDb2x1bW5Db3VudDogbnVtYmVyID0gMCxcbiAgICByb3dDaGVja2JveFZpc2libGU6IGJvb2xlYW4gPSBmYWxzZSxcbiAgICBkZWZhdWx0Um93SGVpZ2h0czogRGVmYXVsdFJvd0hlaWdodHNJZiA9IG5ldyBEZWZhdWx0Um93SGVpZ2h0cygpLFxuICAgIGNvbHVtbkRlZnM6IENvbHVtbkRlZklmW10sXG4gICAgY29sdW1uU2l6ZXM6IG51bWJlcltdID0gW10sXG4gICAgb3ZlcnJpZGluZ0NvbHVtbldpZHRoOiBudW1iZXIgPSAtMSxcbiAgICBjb2x1bW5Db3VudDogbnVtYmVyXG4gICkge1xuICAgIHJldHVybiBuZXcgVGFibGVNb2RlbChcbiAgICAgIGhlYWRlckFyZWFNb2RlbCxcbiAgICAgIGJvZHlBcmVhTW9kZWwsXG4gICAgICBmb290ZXJBcmVhTW9kZWwsXG4gICAgICBmaXhlZExlZnRDb2x1bW5Db3VudCxcbiAgICAgIGZpeGVkUmlnaHRDb2x1bW5Db3VudCxcbiAgICAgIHJvd0NoZWNrYm94VmlzaWJsZSxcbiAgICAgIGRlZmF1bHRSb3dIZWlnaHRzLFxuICAgICAgY29sdW1uRGVmcyxcbiAgICAgIGNvbHVtblNpemVzLFxuICAgICAgb3ZlcnJpZGluZ0NvbHVtbldpZHRoLFxuICAgICAgY29sdW1uQ291bnRcbiAgICApO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBjcmVhdGVCeUFyZWFNb2RlbHNQYXJhbShwYXJhbToge1xuICAgIGhlYWRlckFyZWFNb2RlbD86IEFyZWFNb2RlbElmLFxuICAgIGJvZHlBcmVhTW9kZWw6IEFyZWFNb2RlbElmLFxuICAgIGZvb3RlckFyZWFNb2RlbD86IEFyZWFNb2RlbElmLFxuICAgIGZpeGVkTGVmdENvbHVtbkNvdW50PzogbnVtYmVyLFxuICAgIGZpeGVkUmlnaHRDb2x1bW5Db3VudD86IG51bWJlcixcbiAgICByb3dDaGVja2JveFZpc2libGU/OiBib29sZWFuLFxuICAgIGRlZmF1bHRSb3dIZWlnaHRzPzogRGVmYXVsdFJvd0hlaWdodHNJZixcbiAgICBjb2x1bW5EZWZzPzogQ29sdW1uRGVmSWZbXSxcbiAgICBjb2x1bW5TaXplcz86IG51bWJlcltdLFxuICAgIG92ZXJyaWRpbmdDb2x1bW5XaWR0aD86IG51bWJlcixcbiAgICBjb2x1bW5Db3VudD86IG51bWJlclxuICB9KSB7XG4gICAgcmV0dXJuIFRhYmxlRmFjdG9yeS5jcmVhdGVCeUFyZWFNb2RlbHMoXG4gICAgICBwYXJhbS5oZWFkZXJBcmVhTW9kZWwgPz8gbmV3IEFyZWFNb2RlbEhpZGRlbigpLFxuICAgICAgcGFyYW0uYm9keUFyZWFNb2RlbCxcbiAgICAgIHBhcmFtLmZvb3RlckFyZWFNb2RlbCA/PyBuZXcgQXJlYU1vZGVsSGlkZGVuKCksXG4gICAgICBwYXJhbS5maXhlZExlZnRDb2x1bW5Db3VudCA/PyAwLFxuICAgICAgcGFyYW0uZml4ZWRSaWdodENvbHVtbkNvdW50ID8/IDAsXG4gICAgICBwYXJhbS5yb3dDaGVja2JveFZpc2libGUgPT09IHVuZGVmaW5lZCA/IGZhbHNlIDogcGFyYW0ucm93Q2hlY2tib3hWaXNpYmxlLFxuICAgICAgcGFyYW0uZGVmYXVsdFJvd0hlaWdodHMsXG4gICAgICBwYXJhbS5jb2x1bW5EZWZzID8/IFtdLFxuICAgICAgcGFyYW0uY29sdW1uU2l6ZXMgPz8gW10sXG4gICAgICBwYXJhbS5vdmVycmlkaW5nQ29sdW1uV2lkdGggPz8gLTEsXG4gICAgICBwYXJhbS5jb2x1bW5Db3VudCA/PyAwXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgY3JlYXRlQnlPYmplY3RBcnJheTxUPihcbiAgICByb3dzOiBUW10sXG4gICAgaGVhZGVyOiBzdHJpbmdbXVtdID0gW10sXG4gICAgZm9vdGVyOiBzdHJpbmdbXVtdID0gW10sXG4gICAgZml4ZWRMZWZ0Q29sdW1uQ291bnQ6IG51bWJlciA9IDAsXG4gICAgZml4ZWRSaWdodENvbHVtbkNvdW50OiBudW1iZXIgPSAwLFxuICAgIHJvd0NoZWNrYm94VmlzaWJsZTogYm9vbGVhbiA9IGZhbHNlLFxuICAgIGRlZmF1bHRSb3dIZWlnaHRzOiBEZWZhdWx0Um93SGVpZ2h0c0lmID0gbmV3IERlZmF1bHRSb3dIZWlnaHRzKCksXG4gICAgY29sdW1uRGVmczogQ29sdW1uRGVmSWZbXSxcbiAgICBjb2x1bW5TaXplczogbnVtYmVyW10gPSBbXVxuICApIHtcbiAgICBsZXQgaGVhZGVyQXJlYU1vZGVsOiBBcmVhTW9kZWxJZjtcbiAgICBpZiAoaGVhZGVyPy5sZW5ndGgpIHtcbiAgICAgIGhlYWRlckFyZWFNb2RlbCA9IG5ldyBBcmVhTW9kZWxBcnJheU9mQXJyYXlzPHN0cmluZz4oXCJoZWFkZXJcIiwgaGVhZGVyLCBkZWZhdWx0Um93SGVpZ2h0cy5oZWFkZXIsIGNvbHVtbkRlZnMpO1xuICAgIH0gZWxzZSBpZiAoY29sdW1uRGVmcz8ubGVuZ3RoKSB7XG4gICAgICBoZWFkZXJBcmVhTW9kZWwgPSBuZXcgQXJlYU1vZGVsQXJyYXlPZkFycmF5czxzdHJpbmc+KFwiaGVhZGVyXCIsIFtjb2x1bW5EZWZzLm1hcChkZWYgPT4gZGVmLmhlYWRlckxhYmVsKV0sIGRlZmF1bHRSb3dIZWlnaHRzLmhlYWRlciwgY29sdW1uRGVmcyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGhlYWRlckFyZWFNb2RlbCA9IG5ldyBBcmVhTW9kZWxIaWRkZW4oKTtcbiAgICB9XG4gICAgY29uc3QgZm9vdGVyQXJlYU1vZGVsID0gZm9vdGVyID8gbmV3IEFyZWFNb2RlbEFycmF5T2ZBcnJheXM8c3RyaW5nPihcImZvb3RlclwiLCBmb290ZXIsIGRlZmF1bHRSb3dIZWlnaHRzLmZvb3RlciwgY29sdW1uRGVmcykgOiBuZXcgQXJlYU1vZGVsSGlkZGVuKCk7XG4gICAgY29uc3QgYm9keUFyZWFNb2RlbCA9IG5ldyBBcmVhTW9kZWxPYmplY3RBcnJheVdpdGhDb2x1bW5kZWZzPFQ+KFwiYm9keVwiLCByb3dzLCBjb2x1bW5EZWZzLCBkZWZhdWx0Um93SGVpZ2h0cy5ib2R5KTtcblxuICAgIHJldHVybiBuZXcgVGFibGVNb2RlbChcbiAgICAgIGhlYWRlckFyZWFNb2RlbCxcbiAgICAgIGJvZHlBcmVhTW9kZWwsXG4gICAgICBmb290ZXJBcmVhTW9kZWwsXG4gICAgICBmaXhlZExlZnRDb2x1bW5Db3VudCxcbiAgICAgIGZpeGVkUmlnaHRDb2x1bW5Db3VudCxcbiAgICAgIHJvd0NoZWNrYm94VmlzaWJsZSxcbiAgICAgIGRlZmF1bHRSb3dIZWlnaHRzLFxuICAgICAgY29sdW1uRGVmcyxcbiAgICAgIGNvbHVtblNpemVzXG4gICAgKTtcbiAgfVxufVxuIl19